(function(C,l,u){function ra(){z.DEBUG&&Vex.L("Vex.Flow.Syllable",arguments)}Vex.Flow.Annotation.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Annotation.prototype.getMeiElement=function(){return this.meiElement};Vex.Flow.Annotation.format=function(a,b){if(!a||0===a.length)return!1;for(var c=b.text_line,d=b.top_text_line,f=b.bottom_text_line,e,g=0;g<a.length;++g){var h=a[g];e=h.font.size/10*1.5;1===h.vert_justification?(h.setTextLine(d),d+=e):3===h.vert_justification?
(h.setTextLine(f),f+=e):(h.setTextLine(c),c+=e);e=0<h.getWidth()?h.getWidth():0}b.left_shift+=e/2;b.right_shift+=e/2;b.text_line=c;b.top_text_line=d;b.bottom_text_line=f;return!0};Vex.Flow.Annotation.prototype.draw=function(){var a=Vex.Flow.Annotation,b=Vex.Flow.Modifier;if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation","Can't draw text annotation without an attached note.");var c=this.note.getModifierStartXY(b.Position.ABOVE,
this.index);this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.weight);var b=this.context.measureText(this.text).width,d=this.context.measureText("m").width,c=this.justification==a.Justify.LEFT?this.note.getAbsoluteX():this.justification==a.Justify.RIGHT?c.x-b:this.justification==a.Justify.CENTER?c.x-b/2:this.note.getStemX()-b/2,f,e,g=this.note.hasStem(),h=this.note.getStave();g&&(f=this.note.getStem().getExtents());e=h.getSpacingBetweenLines();this.vert_justification==
a.VerticalJustify.BOTTOM?(a=h.getYForBottomText(this.text_line),g?(f=1===this.note.getStemDirection()?f.baseY:f.topY,a=Math.max(a,f+7+e*(this.text_line+2))):a=Math.max(a,this.note.getYs()[0]+7+e*(this.text_line+2))):this.vert_justification==a.VerticalJustify.CENTER?(f=this.note.getYForTopText(this.text_line)-1,a=h.getYForBottomText(this.text_line),a=f+(a-f)/2+d/2):this.vert_justification==a.VerticalJustify.TOP?(a=Math.min(h.getYForTopText(this.text_line),this.note.getYs()[0]-d),g&&(a=Math.min(a,f.topY-
7-e*this.text_line))):(f=this.note.getStemExtents(),a=f.topY+(f.baseY-f.topY)/2+d/2);this.x=c;this.y=a;this.text_height=d;this.text_width=b;this.context.fillText(this.text,c,a);this.context.restore()};Vex.Flow.Articulation.format=function(a,b){if(!a||0===a.length)return!1;for(var c=b.text_line,d=b.top_text_line,f=b.bottom_text_line,e,g=0;g<a.length;++g){e=a[g];var h=Vex.Flow.articulationCodes(e.type);3===e.position?(e.setTextLine(d),d+=h.between_lines?1:1.5):4===e.position?(e.setTextLine(f),f+=h.between_lines?
1:1.5):(e.setTextLine(c),c+=h.between_lines?1:1.5);e=0<e.getWidth()?e.getWidth():0}b.left_shift+=e/2;b.right_shift+=e/2;b.text_line=c;b.top_text_line=d;b.bottom_text_line=f;return!0};Vex.Flow.Articulation.prototype.draw=function(){var a=Vex.Flow.Modifier;if(!this.context)throw new Vex.RERR("NoContext","Can't draw Articulation without a context.");if(!this.note||null===this.index)throw new Vex.RERR("NoAttachedNote","Can't draw Articulation without a note and index.");var b=this.note.getStemDirection(),
c=this.note.getStave(),d=this.position===a.Position.ABOVE&&b===Vex.Flow.StaveNote.STEM_DOWN||this.position===a.Position.BELOW&&b===Vex.Flow.StaveNote.STEM_UP,f=this.note.getModifierStartXY(this.position,this.index),e=f.y,g=0,e=1,h=c.getSpacingBetweenLines(),g="tabnotes"===this.note.getCategory(),k=this.note.getStem().getExtents(),m=k.topY,p=k.baseY;b===Vex.Flow.StaveNote.STEM_DOWN&&(m=k.baseY,p=k.topY);g&&(this.note.hasStem()?b===Vex.Flow.StaveNote.STEM_UP?p=c.getYForBottomText(this.text_line-2):
b===Vex.Flow.StaveNote.STEM_DOWN&&(m=c.getYForTopText(this.text_line-1.5)):(m=c.getYForTopText(this.text_line-1),p=c.getYForBottomText(this.text_line-2)));b=this.note.getLineNumber(this.position===a.Position.ABOVE);!d&&this.note.beam&&(e=.5*this.note.beam.beam_count);g=e;k=this.position===a.Position.ABOVE?1:-1;d||this.getNote().hasStem()||(b+=3.5*k);d=b+k*g;1<=d&&5>=d&&0===d%1&&(e+=.5);this.position===a.Position.ABOVE?(g=this.articulation.shift_up,a=m-7-h*(this.text_line+e),e=this.articulation.between_lines?
a:Math.min(c.getYForTopText(this.text_line)-3,a)):(g=this.articulation.shift_down-10,a=p+10+h*(this.text_line+e),e=this.articulation.between_lines?a:Math.max(c.getYForBottomText(this.text_line),a));c=f.x+this.articulation.shift_right;e+=g+this.y_shift;Vex.Flow.renderGlyph(this.context,c,e,this.render_options.font_scale,this.articulation.code);this.x=c;this.y=e};Vex.Flow.Beam=function(){function a(a,b){0<arguments.length&&this.init(a,b)}function b(a){var b=0;a.forEach(function(a){a.keyProps&&a.keyProps.forEach(function(a){b+=
a.line-3})});return 0<=b?c.DOWN:c.UP}var c=Vex.Flow.Stem;a.prototype={init:function(a,f){if(!a||a==[])throw new Vex.RuntimeError("BadArguments","No notes provided for beam.");if(1==a.length)throw new Vex.RuntimeError("BadArguments","Too few notes for beam.");this.ticks=a[0].getIntrinsicTicks();if(this.ticks>=Vex.Flow.durationToTicks("4"))throw new Vex.RuntimeError("BadArguments","Beams can only be applied to notes shorter than a quarter note.");var e,g;this.stem_direction=c.UP;for(e=0;e<a.length;++e)if(g=
a[e],g.hasStem()){this.stem_direction=g.getStemDirection();break}var h=this.stem_direction;f&&"stavenotes"===a[0].getCategory()?h=b(a):f&&"tabnotes"===a[0].getCategory()&&(h=-1<a.reduce(function(a,b){return a+b.stem_direction},0)?c.UP:c.DOWN);for(e=0;e<a.length;++e)g=a[e],f&&(g.setStemDirection(h),this.stem_direction=h),g.setBeam(this);this.postFormatted=!1;this.notes=a;this.beam_count=this.getBeamCount();this.break_on_indices=[];this.render_options={beam_width:5,max_slope:.25,min_slope:-.25,slope_iterations:20,
slope_cost:100,show_stemlets:!1,stemlet_extension:7,partial_beam_length:10}},setContext:function(a){this.context=a;return this},getNotes:function(){return this.notes},getBeamCount:function(){return this.notes.map(function(a){return a.getGlyph().beam_count}).reduce(function(a,b){return b>a?b:a})},breakSecondaryAt:function(a){this.break_on_indices=a;return this},getSlopeY:function(a,b,c,g){return c+(a-b)*g},calculateSlope:function(){for(var a=this.notes[0],b=a.getStemExtents().topY,a=a.getStemX(),c=
(this.render_options.max_slope-this.render_options.min_slope)/this.render_options.slope_iterations,g=Number.MAX_VALUE,h=0,k=0,m=this.render_options.min_slope;m<=this.render_options.max_slope;m+=c){for(var p=0,n=0,q=1;q<this.notes.length;++q){var D=this.notes[q],l=D.getStemX(),v=D.getStemExtents().topY;D.isRest()&&(v=-1===this.stem_direction?v+70:v+10);D=this.getSlopeY(l,a,b,m)+n;v*this.stem_direction<D*this.stem_direction?(v=Math.abs(v-D),n+=v*-this.stem_direction,p+=v*q):p+=(v-D)*this.stem_direction}q=
this.notes[this.notes.length-1];q=(q.getStemExtents().topY-b)/(q.getStemX()-a)/2;q=Math.abs(q-m);p=this.render_options.slope_cost*q+Math.abs(p);p<g&&(g=p,h=m,k=n)}this.slope=h;this.y_shift=k},applyStemExtensions:function(){for(var a=this.notes[0],b=a.getStemExtents().topY,a=a.getStemX(),e=0;e<this.notes.length;++e){var g=this.notes[e],h=g.getStemX(),k=g.getStemExtents(),m=k.baseY,k=k.topY,m=m+this.stem_direction*g.glyph.stem_offset,p=Vex.Flow.STEM_WIDTH;if(g.hasStem()){var n=this.getSlopeY(h,a,b,
this.slope)+this.y_shift,q=g.getStemDirection(),l=this.render_options.beam_width,x=l-1,v=0;if(q===this.stem_direction)n=Math.abs(k-n)-c.HEIGHT-1;else{for(var K,r=e;r--;)if(K=this.notes[r],K.stem_direction===this.stem_direction){v=K.getBeamCount();break}1<v&&(v=Math.min(v,g.getGlyph().beam_count),x+=(v-1)*l*1.5);n=-Math.abs(k-n)-c.HEIGHT+.5+x}g.setStem(new Vex.Flow.Stem({x_begin:h-Vex.Flow.STEM_WIDTH/2,x_end:h,y_top:1===q?k:m,y_bottom:1===q?m:k,y_extend:p,stem_extension:n,stem_direction:q}))}}},getBeamLines:function(a){for(var b,
c,g=[],h=!1,k,m=this.render_options.partial_beam_length,p=0;p<this.notes.length;++p){k=this.notes[p];b=this.notes[p-1];var n=this.notes[p+1],q=k.getIntrinsicTicks();c=n;n=0;c&&b&&(n=b.getBeamCount()-c.getBeamCount());c="8"!==a&&0>n;n=k.isRest()?k.getCenterGlyphX():k.getStemX();q<Vex.Flow.durationToTicks(a)?h?(k=g[g.length-1],k.end=n,k=-1!==this.break_on_indices.indexOf(p),q=8<=parseInt(a,10),k&&q&&(h=!1)):k.isRest()||(h={start:n,end:null,flipped:k.getStemDirection()!==this.stem_direction},b&&!c&&
(h.end=n-m),g.push(h),h=!0):(h&&(k=g[g.length-1],null==k.end&&(k.end=k.start+m)),h=!1)}!0===h&&(k=g[g.length-1],null==k.end&&(k.end=k.start-m));return g},drawStems:function(){this.notes.forEach(function(a){a.getStem()&&a.getStem().setContext(this.context).draw()},this)},drawBeamLines:function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw without a canvas context.");var a=["4","8","16","32","64"],b=this.notes[0],e=this.notes[this.notes.length-1],g=b.getStemExtents().topY;e.getStemExtents();
for(var h=b.getStemX(),k=this.render_options.beam_width*this.stem_direction,m=0;m<a.length;++m){for(var p=a[m],p=this.getBeamLines(p),n=0;n<p.length;++n){var q=p[n];if(!q.flipped){var l=q.start-(this.stem_direction==c.DOWN?Vex.Flow.STEM_WIDTH/2:0),x=this.getSlopeY(l,h,g,this.slope),q=q.end+(1==this.stem_direction?Vex.Flow.STEM_WIDTH/3:-Vex.Flow.STEM_WIDTH/3),v=this.getSlopeY(q,h,g,this.slope);this.context.beginPath();this.context.moveTo(l,x+this.y_shift);this.context.lineTo(l,x+k+this.y_shift);this.context.lineTo(q+
1,v+k+this.y_shift);this.context.lineTo(q+1,v+this.y_shift);this.context.closePath();this.context.fill()}}g+=1.5*k}k=this.render_options.beam_width*this.stem_direction*-1;g=b.getStemExtents().topY+.5*k;e.getStemExtents();h=b.getStemX();b=!1;for(m=0;m<a.length;++m){p=a[m];p=this.getBeamLines(p);for(n=0;n<p.length;++n)q=p[n],q.flipped&&(b=!0,l=q.start-(-1*this.stem_direction==c.DOWN?Vex.Flow.STEM_WIDTH/2:0),x=this.getSlopeY(l,h,g,this.slope),q=q.end+(1==-1*this.stem_direction?Vex.Flow.STEM_WIDTH/3:
-Vex.Flow.STEM_WIDTH/3),v=this.getSlopeY(q,h,g,this.slope),this.context.beginPath(),this.context.moveTo(l,x+this.y_shift),this.context.lineTo(l,x+k+this.y_shift),this.context.lineTo(q+1,v+k+this.y_shift),this.context.lineTo(q+1,v+this.y_shift),this.context.closePath(),this.context.fill());b&&(g+=1.5*k)}},preFormat:function(){return this},postFormat:function(){this.postFormatted||(this.calculateSlope(),this.applyStemExtensions(),this.postFormatted=!0)},draw:function(){if(!this.context)throw new Vex.RERR("NoCanvasContext",
"Can't draw without a canvas context.");if(!this.unbeamable)return this.postFormatted||this.postFormat(),this.drawStems(),this.drawBeamLines(),!0}};return a}();Vex.Flow.ClefNote.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.ClefNote.prototype.getMeiElement=function(){return this.meiElement};Vex.Flow.ClefNote.prototype.setOffsetLeft=function(a){this.offsetLeft=a};Vex.Flow.ClefNote.prototype.draw=function(){if(!this.stave)throw new Vex.RERR("NoStave","Can't draw without a stave.");
this.glyph.getContext()||this.glyph.setContext(this.context);var a=this.getAbsoluteX()-(this.offsetLeft||0);this.glyph.setStave(this.stave);this.glyph.setYShift(this.stave.getYForLine(this.clef.line)-this.stave.getYForGlyphs());this.glyph.renderToStave(a);if(this.clef_obj.annotation!==u){var b=new Vex.Flow.Glyph(this.clef_obj.annotation.code,this.clef_obj.annotation.point);b.getContext()||b.setContext(this.context);b.setStave(this.stave);b.setYShift(this.stave.getYForLine(this.clef_obj.annotation.line)-
this.stave.getYForGlyphs());b.setXShift(this.clef_obj.annotation.x_shift);b.renderToStave(a)}};Vex.Flow.Curve.prototype.renderCurve=function(a){var b=this.context,c=this.render_options.cps,d=this.render_options.x_shift,f=this.render_options.y_shift*a.direction,e=a.first_x+d,g=a.first_y+f+(this.render_options.y_shift_start||0),d=a.last_x-d,f=a.last_y+f+(this.render_options.y_shift_end||0),h=this.render_options.thickness,k=(d-e)/(c.length+2);b.beginPath();if(this.render_options.custom_cps){var m=e+
c[0].x,p=g+c[0].y,n=d+c[1].x,c=f+c[1].y;b.moveTo(e,g);b.bezierCurveTo(m,p,n,c,d,f);b.bezierCurveTo(n,c+h,m,p+h,e,g)}else{var m=c[0].x,p=c[0].y,n=c[1].x,c=c[1].y,q=d-e,l=f-g;60>q&&(p=5+q/120*p,c=5+q/120*c);q/=2;l>q?1===a.direction?p+=Math.abs(l):c+=Math.abs(l):l<-q&&(1===a.direction?c+=Math.abs(l):p+=Math.abs(l));b.moveTo(e,g);b.bezierCurveTo(e+k+m,g+p*a.direction,d-k+n,f+c*a.direction,d,f);b.bezierCurveTo(d-k+n,f+(c+h)*a.direction,e+k+m,g+(p+h)*a.direction,e,g)}b.stroke();b.closePath();b.fill()};
Vex.Flow.Curve.prototype.draw=function(){var a=Vex.Flow.Curve;if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var b=this.from,c=this.to,d,f,e,g=d="baseY";f=this.render_options.position_end;this.render_options.position===a.Position.NEAR_TOP&&(g=d="topY");f==a.Position.NEAR_HEAD?g="baseY":f==a.Position.NEAR_TOP&&(g="topY");b?(a=b.getTieRightX(),e=b.getStemDirection(),f=b.getStemExtents()[d]):(a=c.getStave().getSlurStartX(),f=c.getStemExtents()[d]);c?(d=c.getTieLeftX(),e=
c.getStemDirection(),b=c.getStemExtents()[g]):(d=b.getStave().getSlurEndX(),b=b.getStemExtents()[g]);this.renderCurve({first_x:a,last_x:d,first_y:f,last_y:b,direction:e*(!0===this.render_options.invert?-1:1)});return!0};Vex.Flow.articulationCodes.articulations["a^b"]={code:"v16",width:8,shift_right:0,shift_up:6,shift_down:8,between_lines:!1};Vex.Flow.articulationCodes.articulations.avb={code:"v66",width:4,shift_right:0,shift_up:3,shift_down:-3,between_lines:!0};Vex.Flow.Font.glyphs.v66={x_min:-73.5,
x_max:72.140625,ha:74,o:"m -36 -126 b 0 0 -17 -56 -1 0 b 70 -254 0 0 70 -249 l 72 -255 l 0 -255 l -73 -255 l -72 -254 b -36 -126 -72 -254 -55 -195 "};Vex.Flow.Font.glyphs.v16={x_min:-155.171875,x_max:153.8125,ha:157,o:"m -137 353 b -129 355 -134 353 -132 355 b -102 333 -118 355 -111 348 b -8 129 -63 273 -32 205 b 0 106 -4 116 -1 106 b 6 129 0 106 2 116 b 100 333 31 205 62 273 b 114 349 107 344 108 347 b 127 353 118 352 123 353 b 153 327 141 353 153 344 b 144 302 153 320 153 317 b 29 18 96 227 54 123 l 25 -4 b -1 -26 21 -19 13 -26 b -27 -4 -14 -26 -23 -19 l -31 18 b -145 302 -55 123 -98 227 b -155 327 -155 317 -155 320 b -137 353 -155 340 -148 349 "};
Vex.Flow.durationToGlyph.duration_codes["1/2"].type.n={code_head:"noteheadDoubleWholeSquare"};Vex.Flow.durationToTicks.durations["1/4"]||(Vex.Flow.durationToTicks.durations["1/4"]=Vex.Flow.RESOLUTION/.25);Vex.Flow.durationToGlyph.duration_codes["1/4"]||(Vex.Flow.durationToGlyph.duration_codes["1/4"]={common:{head_width:22,stem:!1,stem_offset:0,flag:!1,stem_up_extension:-Vex.Flow.STEM_HEIGHT,stem_down_extension:-Vex.Flow.STEM_HEIGHT,gracenote_stem_up_extension:-Vex.Flow.STEM_HEIGHT,gracenote_stem_down_extension:-Vex.Flow.STEM_HEIGHT,
tabnote_stem_up_extension:-Vex.Flow.STEM_HEIGHT,tabnote_stem_down_extension:-Vex.Flow.STEM_HEIGHT,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadCMNLonga"},h:{code_head:"v59"},m:{code_head:"vf",stem_offset:0},r:{code_head:"v31",head_width:24,rest:!0,position:"B/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}});Vex.Flow.Font.glyphs.noteheadDoubleWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -328 b 724 -350 746 -339 736 -350 b 701 -328 711 -350 701 -339 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.Font.glyphs.noteheadCMNLonga={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -1428 b 724 -1450 746 -1439 736 -1450 b 701 -1428 711 -1450 701 -1439 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.GraceNoteGroup.prototype.draw=function(){function a(a,b){var f=b.getTickContext(),e=f.getExtraPx(),g=f.getX()-e.left-e.extraLeft;a.forEach(function(a){var c=a.getTickContext(),f=c.getX();a.setStave(b.stave);c.setX(g+f)})}if(!this.context)throw new Vex.RuntimeError("NoContext","Can't draw Grace note without a context.");var b=this.getNote();if(!b||null===this.index)throw new Vex.RuntimeError("NoAttachedNote","Can't draw grace note without a parent note and parent note index.");!0!==this.graceNotesAligned&&
(a(this.grace_notes,b),this.graceNotesAligned=!0);this.grace_notes.forEach(function(a){a.setContext(this.context).draw()},this);this.beam&&this.beam.setContext(this.context).draw();this.show_slur&&(this.slur||(this.slur=new Vex.Flow.StaveTie({last_note:this.grace_notes[0],first_note:b,first_indices:[0],last_indices:[0]}),this.slur.render_options.cp2=12),this.slur.setContext(this.context).draw())};Vex.Flow.Hyphen=function(){function a(a){0<arguments.length&&this.init(a)}a.prototype={init:function(a){this.max_hyphen_distance=
a.max_hyphen_distance||75;this.font={family:"Arial",size:10,style:""};this.config=a;this.context=null},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=a;return this},renderHyphen:function(){var a=this.config,c=this.context,d=a.hyphen_width||c.measureText("-").width,f=a.first_annot,e=a.last_annot,a=f.text?f.x+f.text_width:f.x,g=e.x-a;if(g>d)for(f=f.y&&e.y?(f.y+e.y)/2:f.y||e.y,e=Math.ceil(g/this.max_hyphen_distance),g/=e+1;e--;)a+=g,c.fillText("-",a-d/2,f)},draw:function(){if(!this.context)throw new Vex.RERR("NoContext",
"No context to render hyphens.");var a=this.context;a.save();a.setFont(this.font.family,this.font.size,this.font.style);this.renderHyphen();a.restore();return!0}};return a}();Vex.Flow.KeySignature=function(){function a(a,c){0<arguments.length&&this.init(a,c)}a.accidentalSpacing={"#":{above:6,below:4},b:{above:4,below:7},n:{above:3,below:-1}};Vex.Inherit(a,Vex.Flow.StaveModifier,{init:function(b,c){a.superclass.init();this.setPadding(c||10);this.glyphFontScale=38;this.accList=Vex.Flow.keySignature(b)},
addAccToStave:function(b,c,d){var f=Vex.Flow.accidentalCodes(c.type),e=new Vex.Flow.Glyph(f.code,this.glyphFontScale),g=0;"n"===c.type&&d&&(g=a.accidentalSpacing[d.type],g=d.line>=c.line?g.above:g.below);e.setWidth(f.width+g);this.placeGlyphOnLine(e,b,c.line);b.addGlyph(e)},cancelKey:function(a){a=Vex.Flow.keySignature(a);var c=0<this.accList.length&&a[0].type!==this.accList[0].type,d=0,d=c?a.length:a.length-this.accList.length;if(!(1>d)){for(var f=[],e=0;e<d;e++){var g=e;c||(g=a.length-d+e);f.push({type:"n",
line:a[g].line})}this.accList=f.concat(this.accList);return this}},addModifier:function(a){this.convertAccLines(a.clef,this.accList[0].type);for(var c=0;c<this.accList.length;++c)this.addAccToStave(a,this.accList[c],this.accList[c+1])},addToStave:function(a,c){if(0===this.accList.length)return this;c||a.addGlyph(this.makeSpacer(this.padding));this.addModifier(a);return this},convertAccLines:function(a,c){var d=0,f;switch(a){case "bass":d=1;break;case "french":d=1;break;case "alto":d=.5;break;case "tenor":d=
-.5;break;case "mezzo-soprano":d=1.5;break;case "soprano":d=-1;break;case "baritone-f":d=-1.5;break;case "baritone-c":d=-1.5}var e;if(("tenor"===a||"subbass"===a)&&"#"===c)for(f=[3.5,1.5,3,1,2.5,.5,2],e=0;e<this.accList.length;++e)this.accList[e].line=f[e]+d;else if("soprano"===a&&"#"===c)for(f=[3.5,5,3,4.5,2.5,4,2],e=0;e<this.accList.length;++e)this.accList[e].line=f[e]+d;else if(("soprano"===a||"baritone-c"===a||"baritone-f"===a)&&"b"===c)for(f=[2,4,2.5,4.5,3,5,3.5],e=0;e<this.accList.length;++e)this.accList[e].line=
f[e]+d;else if("mezzo-soprano"===a&&"b"===c)for(f=[2,.5,-1,1,-.5,1.5,0],e=0;e<this.accList.length;++e)this.accList[e].line=f[e]+d;else if(("baritone-f"===a||"baritone-c"===a)&&"#"===c)for(f=[3.5,1.5,3,1,2.5,4,2],e=0;e<this.accList.length;++e)this.accList[e].line=f[e]+d;else if("treble"!=a)for(e=0;e<this.accList.length;++e)this.accList[e].line+=d}});return a}();Vex.Flow.ModifierContext=function(){function a(){this.modifiers={};this.postFormatted=this.preFormatted=!1;this.spacing=this.width=0;this.state=
{left_shift:0,right_shift:0,text_line:0,top_text_line:0,bottom_text_line:0};this.PREFORMAT=[Vex.Flow.StaveNote,Vex.Flow.Dot,Vex.Flow.FretHandFinger,Vex.Flow.Accidental,Vex.Flow.GraceNoteGroup,Vex.Flow.Stroke,Vex.Flow.StringNumber,Vex.Flow.Articulation,Vex.Flow.Ornament,Vex.Flow.Annotation,Vex.Flow.Bend,Vex.Flow.Vibrato];this.POSTFORMAT=[Vex.Flow.StaveNote]}function b(){a.DEBUG&&Vex.L("Vex.Flow.ModifierContext",arguments)}a.prototype={addModifier:function(a){var b=a.getCategory();this.modifiers[b]||
(this.modifiers[b]=[]);this.modifiers[b].push(a);a.setModifierContext(this);this.preFormatted=!1;return this},getModifiers:function(a){return this.modifiers[a]},getWidth:function(){return this.width},getExtraLeftPx:function(){return this.state.left_shift},getExtraRightPx:function(){return this.state.right_shift},getState:function(){return this.state},getMetrics:function(){if(!this.formatted)throw new Vex.RERR("UnformattedModifier","Unformatted modifier has no metrics.");return{width:this.state.left_shift+
this.state.right_shift+this.spacing,spacing:this.spacing,extra_left_px:this.state.left_shift,extra_right_px:this.state.right_shift}},preFormat:function(){this.preFormatted||(this.PREFORMAT.forEach(function(a){b("Preformatting ModifierContext: ",a.CATEGORY);a.format(this.getModifiers(a.CATEGORY),this.state,this)},this),this.width=this.state.left_shift+this.state.right_shift,this.preFormatted=!0)},postFormat:function(){this.postFormatted||this.POSTFORMAT.forEach(function(a){b("Postformatting ModifierContext: ",
a.CATEGORY);a.postFormat(this.getModifiers(a.CATEGORY),this)},this)}};return a}();Vex.Flow.Ornament.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Ornament.prototype.getMeiElement=function(){return this.meiElement};Vex.Flow.Ornament.format=function(a,b){if(!a||0===a.length)return!1;for(var c=b.text_line,d=b.top_text_line,f=b.bottom_text_line,e,g=0;g<a.length;++g){e=a[g];var h=Vex.Flow.ornamentCodes(e.type);3===e.position?(e.setTextLine(d),d+=h.between_lines?1:1.5):4===
e.position?(e.setTextLine(f),f+=h.between_lines?1:1.5):(e.setTextLine(c),c+=h.between_lines?1:1.5);e=0<e.getWidth()?e.getWidth():0}b.left_shift+=e/2;b.right_shift+=e/2;b.text_line=c;b.top_text_line=d;b.bottom_text_line=f;return!0};Vex.Flow.Ornament.prototype.draw=function(){function a(a,b,c){var d=Vex.Flow.accidentalCodes(b),f=h-3,e=k+2;b={n:{shift_x:1,shift_y_upper:0,shift_y_lower:0,height:17},"#":{shift_x:0,shift_y_upper:-2,shift_y_lower:-2,height:20},b:{shift_x:1,shift_y_upper:0,shift_y_lower:3,
height:18},"##":{shift_x:0,shift_y_upper:0,shift_y_lower:0,height:12},bb:{shift_x:0,shift_y_upper:0,shift_y_lower:4,height:17},db:{shift_x:-3,shift_y_upper:0,shift_y_lower:4,height:17},bbs:{shift_x:0,shift_y_upper:0,shift_y_lower:4,height:17},d:{shift_x:0,shift_y_upper:0,shift_y_lower:0,height:17},"++":{shift_x:-2,shift_y_upper:-6,shift_y_lower:-3,height:22},"+":{shift_x:1,shift_y_upper:-4,shift_y_lower:-2,height:20}}[b];c?(e-=b?b.height:18,e+="tr"===m.type?-8:0):e+="tr"===m.type?-6:0;b&&(f+=b.shift_x,
e+=c?b.shift_y_upper:b.shift_y_lower);Vex.Flow.renderGlyph(a,f,e,m.render_options.font_scale/1.3,d.code);c||(k-=b?b.height:18)}if(!this.context)throw new Vex.RERR("NoContext","Can't draw Ornament without a context.");if(!this.note||null===this.index)throw new Vex.RERR("NoAttachedNote","Can't draw Ornament without a note and index.");var b=this.context,c=this.note.getStemDirection(),d=this.note.getStave(),f=this.note.getStem().getExtents(),f=c===Vex.Flow.StaveNote.STEM_DOWN?f.baseY:f.topY;"tabnotes"===
this.note.getCategory()&&(this.note.hasStem()?c!==Vex.Flow.StaveNote.STEM_UP&&c===Vex.Flow.StaveNote.STEM_DOWN&&(f=d.getYForTopText(this.text_line-1.5)):f=d.getYForTopText(this.text_line-1));var c=c===Vex.Flow.StaveNote.STEM_DOWN,e=d.getSpacingBetweenLines(),g=1;!c&&this.note.beam&&(g+=.5);var f=f-7-e*(this.text_line+g),h=this.note.getModifierStartXY(this.position,this.index).x+this.ornament.shift_right,k=Math.min(d.getYForTopText(this.text_line)-3,f),k=k+(this.ornament.shift_up+this.y_shift);this.delayed&&
(h+=this.ornament.width,h=(f=Vex.Flow.TickContext.getNextContext(this.note.getTickContext()))?h+.5*(f.getX()-h):h+.5*(d.x+d.width-h));var m=this;this.accidental_lower&&a(b,this.accidental_lower,!1,h,k);Vex.Flow.renderGlyph(b,h,k,this.render_options.font_scale,this.ornament.code);this.x=h;this.y=k;this.accidental_upper&&a(b,this.accidental_upper,!0,h,k)};Vex.Flow.Stave=function(){function a(a,b,f,e){0<arguments.length&&this.init(a,b,f,e)}var b=1<Vex.Flow.STAVE_LINE_THICKNESS?Vex.Flow.STAVE_LINE_THICKNESS:
0;a.prototype={init:function(a,b,f,e){this.x=a;this.y=b;this.width=f;this.start_x=this.getGlyphStartX();this.end_x=this.getGlyphEndX();this.context=null;this.glyphs=[];this.end_glyphs=[];this.modifiers=[];this.measure=0;this.clef="treble";this.font={family:"sans-serif",size:8,weight:""};this.options={vertical_bar_width:10,glyph_spacing_px:10,num_lines:5,fill_style:"#999999",spacing_between_lines_px:10,space_above_staff_ln:4,space_below_staff_ln:4,top_text_position:1};this.bounds={x:this.x,y:this.y,
w:this.width,h:0};Vex.Merge(this.options,e);this.resetLines();this.modifiers.push(new Vex.Flow.Barline(Vex.Flow.Barline.type.SINGLE,this.x));this.modifiers.push(new Vex.Flow.Barline(Vex.Flow.Barline.type.SINGLE,this.x+this.width))},getGlyphStartX:function(){return this.x+5},getGlyphEndX:function(){return this.x+this.width},resetLines:function(){this.options.line_config=[];for(var a=0;a<this.options.num_lines;a++)this.options.line_config.push({visible:!0});this.height=(this.options.num_lines+this.options.space_above_staff_ln)*
this.options.spacing_between_lines_px;this.options.bottom_text_position=this.options.num_lines+1},setNoteStartX:function(a){this.start_x=a;return this},getNoteStartX:function(){var a=this.start_x;this.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&2<this.modifiers.length&&(a+=20);return a},getNoteEndX:function(){return this.end_x},getTieStartX:function(){return this.start_x},getTieEndX:function(){return this.x+this.width},setContext:function(a){this.context=a;return this},getContext:function(){return this.context},
setX:function(a){var b;b="number"==typeof this.x?a-this.x:0;this.x=a;this.bounds.x=a;this.start_x+=b;for(b=0;b<this.modifiers.length;b++)this.modifiers[b].x=a;return this},getX:function(){return this.x},getNumLines:function(){return this.options.num_lines},setNumLines:function(a){this.options.num_lines=parseInt(a,10);this.resetLines();return this},setY:function(a){this.y=a;return this},setWidth:function(a){this.width=a;this.end_x=this.getGlyphEndX();this.modifiers[1].setX(this.end_x);return this},
getWidth:function(){return this.width},setMeasure:function(a){this.measure=a;return this},setBegBarType:function(a){if(a==Vex.Flow.Barline.type.SINGLE||a==Vex.Flow.Barline.type.REPEAT_BEGIN||a==Vex.Flow.Barline.type.NONE)this.modifiers[0]=new Vex.Flow.Barline(a,this.x);return this},setEndBarType:function(a){a!=Vex.Flow.Barline.type.REPEAT_BEGIN&&(this.modifiers[1]=new Vex.Flow.Barline(a,this.x+this.width));return this},getModifierXShift:function(a){"undefined"===typeof a&&(a=this.glyphs.length-1);
"number"!==typeof a&&new Vex.RERR("InvalidIndex","Must be of number type");for(var b=this.getGlyphStartX(),f=0,e=0;e<a+1;++e)var g=this.glyphs[e],b=b+g.getMetrics().width,f=f+g.getMetrics().width;0<f&&(f+=this.options.vertical_bar_width+10);return f},setRepetitionTypeLeft:function(a,b){this.modifiers.push(new Vex.Flow.Repetition(a,this.x,b));return this},setRepetitionTypeRight:function(a,b){this.modifiers.push(new Vex.Flow.Repetition(a,this.x,b));return this},setVoltaType:function(a,b,f){this.modifiers.push(new Vex.Flow.Volta(a,
b,this.x,f));return this},setSection:function(a,b){this.modifiers.push(new Vex.Flow.StaveSection(a,this.x,b));return this},setTempo:function(a,b){this.modifiers.push(new Vex.Flow.StaveTempo(a,this.x,b));return this},setText:function(a,b,f){this.modifiers.push(new Vex.Flow.StaveText(a,b,f));return this},getHeight:function(){return this.height},getSpacingBetweenLines:function(){return this.options.spacing_between_lines_px},getBoundingBox:function(){return new Vex.Flow.BoundingBox(this.x,this.y,this.width,
this.getBottomY()-this.y)},getBottomY:function(){var a=this.options,b=a.spacing_between_lines_px;return this.getYForLine(a.num_lines)+a.space_below_staff_ln*b},getBottomLineY:function(){return this.getYForLine(this.options.num_lines)},getYForLine:function(a){var d=this.options,f=d.spacing_between_lines_px;return this.y+(a*f+d.space_above_staff_ln*f)-b/2},getYForTopText:function(a,b){return this.getYForLine(-((a||0)*(b||1))-this.options.top_text_position)},getYForBottomText:function(a,b){return this.getYForLine(this.options.bottom_text_position+
(a||0)*(b||1))},getYForNote:function(a){var b=this.options,f=b.spacing_between_lines_px;return this.y+b.space_above_staff_ln*f+5*f-a*f},getYForGlyphs:function(){return this.getYForLine(3)},addGlyph:function(a){a.setStave(this);this.glyphs.push(a);this.start_x+=a.getMetrics().width;return this},addEndGlyph:function(a){a.setStave(this);this.end_glyphs.push(a);this.end_x-=a.getMetrics().width;return this},addModifier:function(a){this.modifiers.push(a);a.addToStave(this,0===this.glyphs.length);return this},
addEndModifier:function(a){this.modifiers.push(a);a.addToStaveEnd(this,0===this.end_glyphs.length);return this},addKeySignature:function(a){this.addModifier(new Vex.Flow.KeySignature(a));return this},addClef:function(a,b,f){this.clef=a;this.addModifier(new Vex.Flow.Clef(a,b,f));return this},addEndClef:function(a,b,f){this.addEndModifier(new Vex.Flow.Clef(a,b,f));return this},addTimeSignature:function(a,b){this.addModifier(new Vex.Flow.TimeSignature(a,b));return this},addEndTimeSignature:function(a,
b){this.addEndModifier(new Vex.Flow.TimeSignature(a,b))},addTrebleGlyph:function(){this.clef="treble";this.addGlyph(new Vex.Flow.Glyph("v83",40));return this},draw:function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");for(var a=this.options.num_lines,b=this.width,f=this.x,e,g=0;g<a;g++)e=this.getYForLine(g),this.context.save(),this.context.setFillStyle(this.options.fill_style),this.context.setStrokeStyle(this.options.fill_style),this.options.line_config[g].visible&&
this.context.fillRect(f,e,b,Vex.Flow.STAVE_LINE_THICKNESS),this.context.restore();f=this.getGlyphStartX();for(a=0;a<this.glyphs.length;++a)e=this.glyphs[a],e.getContext()||e.setContext(this.context),e.renderToStave(f),f+=e.getMetrics().width;f=this.getGlyphEndX();for(a=0;a<this.end_glyphs.length;++a)e=this.end_glyphs[a],e.getContext()||e.setContext(this.context),f-=e.getMetrics().width,e.renderToStave(f);for(a=0;a<this.modifiers.length;a++)"function"==typeof this.modifiers[a].draw&&this.modifiers[a].draw(this,
this.getModifierXShift());0<this.measure&&(this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight),f=this.context.measureText(""+this.measure).width,e=this.getYForTopText(0)+3,this.context.fillText(""+this.measure,this.x-f/2,e),this.context.restore());return this},drawVertical:function(a,b){this.drawVerticalFixed(this.x+a,b)},drawVerticalFixed:function(a,b){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var f=this.getYForLine(0),
e=this.getYForLine(this.options.num_lines-1);b&&this.context.fillRect(a-3,f,1,e-f+1);this.context.fillRect(a,f,1,e-f+1)},drawVerticalBar:function(a){this.drawVerticalBarFixed(this.x+a,!1)},drawVerticalBarFixed:function(a){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var b=this.getYForLine(0),f=this.getYForLine(this.options.num_lines-1);this.context.fillRect(a,b,1,f-b+1)},getConfigForLines:function(){return this.options.line_config},setConfigForLine:function(a,
b){if(a>=this.options.num_lines||0>a)throw new Vex.RERR("StaveConfigError","The line number must be within the range of the number of lines in the Stave.");if(!b.hasOwnProperty("visible"))throw new Vex.RERR("StaveConfigError","The line configuration object is missing the 'visible' property.");if("boolean"!==typeof b.visible)throw new Vex.RERR("StaveConfigError","The line configuration objects 'visible' property must be true or false.");this.options.line_config[a]=b;return this},setConfigForLines:function(a){if(a.length!==
this.options.num_lines)throw new Vex.RERR("StaveConfigError","The length of the lines configuration array must match the number of lines in the Stave");for(var b in a)a[b]||(a[b]=this.options.line_config[b]),Vex.Merge(this.options.line_config[b],a[b]);this.options.line_config=a;return this}};return a}();Vex.Flow.StaveNote.prototype.getTieRightX=function(){var a=this.getAbsoluteX();return a+=this.glyph.head_width+this.x_shift+this.extraRightPx};Vex.Flow.StaveNote.prototype.getYForBottomText=function(a){var b=
this.getStemExtents();return Vex.Max(this.stave.getYForBottomText(a),b.baseY+this.render_options.annotation_spacing*(a+1))};Vex.Flow.StaveNote.prototype.draw=function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw without a canvas context.");if(!this.stave)throw new Vex.RERR("NoStave","Can't draw without a stave.");if(0===this.ys.length)throw new Vex.RERR("NoYValues","Can't draw note without Y values.");var a=this.getNoteHeadBeginX(),b=this.getNoteHeadEndX(),c=this.hasStem()&&
!this.beam;this.note_heads.forEach(function(b){b.setX(a)},this);this.stem.setNoteHeadXBounds(a,b);this.drawLedgerLines();c&&this.drawStem();this.drawNoteHeads();this.drawFlag();this.drawModifiers()};Vex.Flow.StaveHairpin=function(){function a(a,c){0<arguments.length&&this.init(a,c)}a.type={CRESC:1,DECRESC:2};a.FormatByTicksAndDraw=function(b,c,d,f,e,g){c=c.pixelsPerTick;if(null==c)throw new Vex.RuntimeError("BadArguments","A valid Formatter must be provide to draw offsets by ticks.");g={height:g.height,
y_shift:g.y_shift,left_shift_px:c*g.left_shift_ticks,right_shift_px:c*g.right_shift_ticks};(new a({first_note:d.first_note,last_note:d.last_note},f)).setContext(b).setRenderOptions(g).setPosition(e).draw()};a.prototype={setMeiElement:function(a){this.meiElement=a;return this},getMeiElement:function(){return this.meiElement},init:function(a,c){this.setNotes(a);this.hairpin=c;this.position=Vex.Flow.Modifier.Position.BELOW;this.context=null;this.render_options={height:10,y_shift:0,left_shift_px:0,right_shift_px:0};
this.setNotes(a)},setContext:function(a){this.context=a;return this},setPosition:function(a){if(a==Vex.Flow.Modifier.Position.ABOVE||a==Vex.Flow.Modifier.Position.BELOW)this.position=a;return this},setRenderOptions:function(a){a&&Vex.Merge(this.render_options,a);return this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Hairpin needs to have either first_note or last_note set.");this.first_note=a.first_note;this.last_note=a.last_note;return this},renderHairpin:function(b){var c=
this.context;c.save();c.lineWidth=1.3;c.beginPath();var d=this.render_options.y_shift+20,f=b.first_y;this.position==Vex.Flow.Modifier.Position.ABOVE&&(d=-d+30,f=b.first_y-b.staff_height);var e=this.render_options.left_shift_px,g=this.render_options.right_shift_px,h;h=b.first_x+e;g=b.last_x+g;d=f+d;f=this.render_options.height;this.x=h;this.x1=g;this.y=d;this.height=f;switch(this.hairpin){case a.type.CRESC:b.continued_left?(b=.2*f,c.moveTo(g+e,d),c.lineTo(h,d+b),c.moveTo(h+e,d+f-b)):(c.moveTo(g,d),
c.lineTo(h,d+f/2));c.lineTo(g,d+f);break;case a.type.DECRESC:b.continued_right?(b=.2*f,c.moveTo(h+e,d),c.lineTo(g,d+b),c.moveTo(g+e,d+f-b)):(c.moveTo(h+e,d),c.lineTo(g,d+f/2)),c.lineTo(h,d+f)}c.stroke();c.restore()},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw Hairpin without a context.");var a=this.first_note,c=this.last_note,d,f;if(a&&c)return d=a.getModifierStartXY(this.position,0),f=c.getModifierStartXY(this.position,0),this.renderHairpin({first_x:d.x,last_x:f.x,
first_y:a.getStave().y+a.getStave().height,staff_height:a.getStave().height,continued_left:!1,continued_right:!1}),!0;if(a)return d=a.getModifierStartXY(this.position,0),this.renderHairpin({first_x:d.x,last_x:a.getStave().getSlurEndX(),first_y:a.getStave().y+a.getStave().height,staff_height:a.getStave().height,continued_left:!1,continued_right:!0}),!0;f=c.getModifierStartXY(this.position,0);this.renderHairpin({first_x:c.getStave().getSlurStartX(),last_x:f.x,first_y:c.getStave().y+c.getStave().height,
staff_height:c.getStave().height,continued_left:!0,continued_right:!1})}};return a}();Vex.Flow.StaveTie=function(){function a(a,c){0<arguments.length&&this.init(a,c)}a.prototype={init:function(a,c){this.notes=a;this.context=null;this.text=c;this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}};this.font=this.render_options.font;this.setNotes(a)},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=
a;return this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");a.first_indices||(a.first_indices=[0]);a.last_indices||(a.last_indices=[0]);if(a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments","Tied notes must have similar index sizes");this.first_note=a.first_note;this.first_indices=a.first_indices;this.last_note=a.last_note;this.last_indices=a.last_indices;
return this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.direction=a},getDir:function(){return this.direction},renderTie:function(a){if(0===a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");var c=this.context,d=this.render_options.cp1,f=this.render_options.cp2;10>Math.abs(a.last_x_px-a.first_x_px)&&(d=2,f=8);for(var e=this.render_options.first_x_shift,g=this.render_options.last_x_shift,h=this.render_options.y_shift*
a.direction,k=0;k<this.first_indices.length;++k){var m=(a.last_x_px+g+(a.first_x_px+e))/2,p=a.first_ys[this.first_indices[k]]+h,n=a.last_ys[this.last_indices[k]]+h;if(isNaN(p)||isNaN(n))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");var q=(p+n)/2+d*a.direction,l=(p+n)/2+f*a.direction;c.beginPath();c.moveTo(a.first_x_px+e,p);c.quadraticCurveTo(m,q,a.last_x_px+g,n);c.quadraticCurveTo(m,l,a.first_x_px+e,p);c.closePath();c.fill()}},renderText:function(a,c){if(this.text){var d;d=(a+
c)/2-this.context.measureText(this.text).width/2;this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.style);this.context.fillText(this.text,d+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-1);this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a=this.first_note,c=this.last_note,d,f,e,g;a?(d=a.getTieRightX()+this.render_options.tie_spacing,g=a.getStemDirection(),
e=a.getYs()):(d=c.getStave().getTieStartX(),e=c.getYs(),this.first_indices=this.last_indices);c?(f=c.getTieLeftX()+this.render_options.tie_spacing,g=c.getStemDirection(),a=c.getYs()):(f=a.getStave().getTieEndX(),a=a.getYs(),this.last_indices=this.first_indices);this.direction||(this.direction=g);this.renderTie({first_x_px:d,last_x_px:f,first_ys:e,last_ys:a,direction:this.direction});this.renderText(d,f);return!0}};return a}();Vex.Flow.Volta.prototype.draw=function(a,b){b-=a.getModifierXShift();var c=
Vex.Flow.Volta;if(!a.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var d=a.context,f=a.width,e=a.getYForTopText(a.options.num_lines)+this.y_shift,g=1.5*a.options.spacing_between_lines_px;switch(this.volta){case Vex.Flow.Volta.type.BEGIN:d.fillRect(this.x+b,e,1,g);break;case Vex.Flow.Volta.type.END:f-=5;d.fillRect(this.x+b+f,e,1,g);break;case Vex.Flow.Volta.type.BEGIN_END:f-=3,d.fillRect(this.x+b,e,1,g),d.fillRect(this.x+b+f,e,1,g)}if(this.volta==c.type.BEGIN||
this.volta==c.type.BEGIN_END)d.save(),d.setFont(this.font.family,this.font.size,this.font.weight),d.fillText(this.number,this.x+b+5,e+15),d.restore();d.fillRect(this.x+b,e,f,1);return this};Vex.Flow.Stroke=function(){function a(a,b){0<arguments.length&&this.init(a,b)}a.CATEGORY="strokes";a.Type={ROLL:0,BRUSH_DOWN:1,BRUSH_UP:2,ROLL_DOWN:3,ROLL_UP:4,RASQUEDO_DOWN:5,RASQUEDO_UP:6};var b=Vex.Flow.Modifier;a.format=function(a,b){var f=b.left_shift;if(!a||0===a.length)return this;var e=[],g,h,k;for(g=0;g<
a.length;++g){h=a[g];k=h.getNote();var m;k instanceof Vex.Flow.StaveNote?(m=k.getKeyProps()[h.getIndex()],k=m.displaced?k.getExtraLeftPx():0,e.push({line:m.line,shift:k,str:h})):(m=k.getPositions()[h.getIndex()],e.push({line:m.str,shift:0,str:h}))}for(g=m=0;g<e.length;++g)h=e[g].str,k=e[g].shift,h.setXShift(f+k),m=Math.max(h.getWidth()+0,m);b.left_shift+=m;return!0};Vex.Inherit(a,b,{init:function(c,d){a.superclass.init.call(this);this.note=null;this.options=Vex.Merge({},d);this.all_voices="all_voices"in
this.options?this.options.all_voices:!0;this.index=this.note_end=null;this.type=c;this.position=b.Position.LEFT;this.render_options={font_scale:38,stroke_px:3,stroke_spacing:10};this.font={family:"serif",size:10,weight:"bold italic"};this.setXShift(0);this.setWidth(10)},getPosition:function(){return this.position},addEndNote:function(a){this.note_end=a;return this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw stroke without a context.");if(!this.note||null==this.index)throw new Vex.RERR("NoAttachedNote",
"Can't draw stroke without a note and index.");var b=this.note.getModifierStartXY(this.position,this.index),d=this.note.getYs(),f=b.y,e=b.y,b=b.x-5,g=this.note.stave.options.spacing_between_lines_px,h=this.getModifierContext().getModifiers(this.note.getCategory()),k;for(k=0;k<h.length;k++)for(var d=h[k].getYs(),m=0;m<d.length;m++)if(this.note==h[k]||this.all_voices)f=Vex.Min(f,d[m]),e=Vex.Max(e,d[m]);var p,n,q,l,x;switch(this.type){case a.Type.BRUSH_DOWN:p="vc3";n=-3;q=f-g/2+10;e+=g/2;break;case a.Type.BRUSH_UP:p=
"v11";n=.5;q=e+g/2;f-=g/2;break;case a.Type.ROLL:f+=g/2;e=this.note instanceof Vex.Flow.StaveNote&&0!==(e-f)%2?e+.5*g:e+g;break;case a.Type.ROLL_DOWN:case a.Type.RASQUEDO_DOWN:p="vc3";n=-3;l=this.x_shift+n-2;this.note instanceof Vex.Flow.StaveNote?(f+=1.5*g,e=0!==(e-f)%2?e+.5*g:e+g,q=f-g,x=e+g+2):(f+=1.5*g,e+=g,q=f-.75*g,x=e+.25*g);break;case a.Type.ROLL_UP:case a.Type.RASQUEDO_UP:p="v52",n=-4,l=this.x_shift+n-1,this.note instanceof Vex.Flow.StaveNote?(f+=.5*g,0===(e-f)%2&&(e+=g/2),q=e+.5*g,x=f-1.25*
g):(f+=.25*g,e+=.5*g,q=e+.25*g,x=f-g)}if(this.type==a.Type.BRUSH_DOWN||this.type==a.Type.BRUSH_UP)this.context.fillRect(b+this.x_shift,f,1,e-f);else if(this.note instanceof Vex.Flow.StaveNote)for(k=f;k<=e;k+=g)Vex.Flow.renderGlyph(this.context,b+this.x_shift-4,k,this.render_options.font_scale,"va3");else{for(k=f;k<=e;k+=10)Vex.Flow.renderGlyph(this.context,b+this.x_shift-4,k,this.render_options.font_scale,"va3");this.type==Vex.Flow.Stroke.Type.RASQUEDO_DOWN&&(x=k+.25*g)}this.type!==a.Type.ROLL&&Vex.Flow.renderGlyph(this.context,
b+this.x_shift+n,q,this.render_options.font_scale,p);if(this.type==a.Type.RASQUEDO_DOWN||this.type==a.Type.RASQUEDO_UP)this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight),this.context.fillText("R",b+l,x),this.context.restore()}});return a}();Vex.Flow.Tremolo.prototype.draw=function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw Tremolo without a context.");if(!this.note||null==this.index)throw new Vex.RERR("NoAttachedNote","Can't draw Tremolo without a note and index.");
var a=this.note.getStem(),b;"w"===this.note.duration?(b=(a.x_end+a.x_begin)/2,1===a.stem_direction?a=a.getExtents().topY-this.y_spacing*this.num/2+a.stem_extension:(a=this.note.getModifierStartXY(this.position,this.index),a=a.y)):1===a.stem_direction?(b=a.x_end,a=a.getExtents().topY-this.y_spacing*this.num/2):(a=this.note.getModifierStartXY(this.position,this.index),b=a.x,a=a.y);b+=this.shift_right;for(var c=0;c<this.num;++c)Vex.Flow.renderGlyph(this.context,b,a,this.render_options.font_scale,this.code),
a+=this.y_spacing};window.MeiLib||(window.MeiLib={});MeiLib.RuntimeError=function(a,b){this.errorcode=a;this.message=b};MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};window.MeiLib||(window.MeiLib={});MeiLib.EventEnumerator=function(a,b){this.init(a,b)};MeiLib.EventEnumerator.prototype.init=function(a,b){if(!a)throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");this.node=a;
this.next_evnt=null;this.EoI=!0;this.children=this.node.childNodes;this.i_next=-1;this.proportion=b||{num:1,numbase:1};this.outputProportion=b||{num:1,numbase:1};this.read_ahead()};MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.");};MeiLib.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=
null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()};MeiLib.EventEnumerator.prototype.step_ahead=function(){for(var a=!1,b=this.i_next,c=this.children;!a;)if(++b,b===c.length||1===c[b].nodeType)a=!0;b<c.length?(this.next_evnt=c[b],a=this.next_evnt.localName,"note"===a||"rest"===a||"mRest"===a||"chord"===a?this.EoI=!1:"beam"===a?(this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),
this.EoI=!1)):"tuplet"===a&&(a={num:this.proportion.num*+this.next_evnt.getAttribute("num")||3,numbase:this.proportion.numbase*+this.next_evnt.getAttribute("numbase")||2},this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt,a),this.beam_enumerator.EoI?(this.outputProportion=this.proportion,this.EoI=!0):(this.outputProportion=this.beam_enumerator.outputProportion,this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))):this.EoI=!0;this.i_next=b};window.MeiLib||(window.MeiLib={});MeiLib.SliceMEI=
function(a,b){var c,d,f=function(a,b){var c,d,f;c=0;for(d=a.length;c<d;c++)f=a[c],b.noClef&&f.setAttribute("clef.visible","false"),b.noKey&&f.setAttribute("key.sig.show","false"),b.noMeter&&f.setAttribute("meter.rend","false")},e=function(a,b,c,d){var f,e,g,h,k=!1;b||("measure"===a.localName&&Number(a.getAttribute("n"))===d.start_n?b=!0:(a.parentNode.removeChild(a),k=!0));if(b){if(d.staves&&1===a.nodeType){e=a.querySelectorAll("[staff]"+c);c=0;for(f=e.length;c<f;c++)e[c].parentNode.removeChild(e[c]);
e=a.getElementsByTagName("staff");c=0;for(f=e.length;c<f;c++)g=e[c],h=Number(g.getAttribute("n")),-1===d.staves.indexOf(h)&&(g.parentNode.removeChild(g),c--,f--)}"measure"===a.localName&&Number(a.getAttribute("n"))===d.end_n&&(b=!1)}return{inside_slice:b,removed:k}},g=b.staves;if(g){var h="",k="";c=0;for(d=g.length;c<d;c++)h+=':not([n="'+g[c]+'"])',k+=':not([staff="'+g[c]+'"])'}var m=a.cloneNode(!0);if(g)for(g=m.querySelectorAll("staffDef"+h),c=0,d=g.length;c<d;c++)g[c].parentNode.removeChild(g[c]);
if(b.noClef||b.noKey||b.noMeter)c=m.getElementsByTagName("scoreDef")[0],d=c.getElementsByTagName("staffDef"),f([c],b),f(d,b);if(b.noConnectors)for(f=m.getElementsByTagName("staffGrp"),c=0,d=f.length;c<d;c++)f[c].removeAttribute("symbol");f=!1;c=m.getElementsByTagName("section")[0].childNodes;for(var p,n,q,g=0,h=c.length;g<h;g++)if(d=c[g],"ending"===d.localName){var l=d.childNodes;p=0;for(n=l.length;p<n;p++)q=e(l[p],f,k,b),f=q.inside_slice,q.removed&&(p--,n--);0===d.getElementsByTagName("measure").length&&
(d.parentNode.removeChild(d),g--,h--)}else q=e(d,f,k,b),f=q.inside_slice,q.removed&&(g--,h--);return m};window.MeiLib||(window.MeiLib={});MeiLib.Alt=function(a,b,c,d){this.elem=a;this.xmlID=b;this.altitems=[];this.parentID=c;this.tagname=d};MeiLib.Alt.prototype.getDefaultItem=function(){var a=function(a,c,d){var f,e;for(e in a){if(a[e].tagname===c)return a[e];f||a[e].tagname!==d||(f=a[e])}return f};if("choice"===this.tagname)return a(this.altitems,"corr","sic");if("app"===this.tagname)return a(this.altitems,
"lem")};window.MeiLib||(window.MeiLib={});MeiLib.Variant=function(a,b,c,d,f,e){this.elem=a;this.xmlID=b;this.tagname=c;this.source=d;this.resp=f;this.n=e};window.MeiLib||(window.MeiLib={});MeiLib.MeiDoc=function(a){a&&this.init(a)};MeiLib.MeiDoc.prototype.init=function(a){this.xmlDoc=a;this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0];this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0];this.rich_score=this.rich_music.getElementsByTagName("score")[0];
this.parseSourceList();this.parseEditorList();this.parseALTs();this.initAltgroups();this.initSectionView()};MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score};MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score};MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs};MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList};MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList};MeiLib.MeiDoc.prototype.parseSourceList=
function(){var a=function(a){return 1===a.nodeType},b=this.rich_head.getElementsByTagName("sourceDesc")[0];return this.sources=b?Array.prototype.filter.call(b.childNodes,a):[]};MeiLib.MeiDoc.prototype.parseEditorList=function(){var a=function(a){return"editor"===a.localName},b=this.rich_head.getElementsByTagName("titleStmt")[0];return this.editors=b?Array.prototype.filter.call(b.childNodes,a):[]};MeiLib.MeiDoc.prototype.parseALTs=function(){var a,b;this.ALTs={};var c=this.rich_score.querySelectorAll("app, choice");
for(a=0;a<c.length;a++){var d=c[a];b=d.parentNode;var f=d.querySelectorAll("rdg, lem, sic, corr"),e=new MeiLib.Alt(d,MeiLib.XMLID(d),MeiLib.XMLID(b),d.localName);e.altitems={};for(b=0;b<f.length;b++){var g=f[b],h=g.getAttribute("source"),k=g.getAttribute("resp"),m=g.getAttribute("n"),p=g.localName,n=MeiLib.XMLID(g);e.altitems[n]=new MeiLib.Variant(g,n,p,h,k,m)}this.ALTs[MeiLib.XMLID(d)]=e}};MeiLib.MeiDoc.prototype.initAltgroups=function(){var a,b,c,d,f=this.rich_score.querySelectorAll('annot[type="appGrp"], annot[type="choiceGrp"]');
this.altgroups={};for(a=0;a<f.length;a++){c=[];d=f[a].getAttribute("plist").split(" ");for(b=0;b<d.length;b++)c.push(d[b].replace("#",""));for(b in c)this.altgroups[c[b]]=c}};MeiLib.MeiDoc.prototype.selectDefaultAlternative=function(a){var b={};if("choice"===a.localName){var c=a.getElementsByTagName("corr")[0];c?(b.alt_item_xml_id=MeiLib.XMLID(c),b.alt_item=c):(a=a.getElementsByTagName("sic")[0])?(b.alt_item_xml_id=MeiLib.XMLID(a),b.alt_item=a):b={}}else(c=a.getElementsByTagName("lem")[0])?(b.alt_item_xml_id=
MeiLib.XMLID(c),b.alt_item=c):(a=a.getElementsByTagName("rdg")[0])?(b.alt_item_xml_id=MeiLib.XMLID(a),b.alt_item=a):b={};return b};MeiLib.MeiDoc.prototype.initSectionView=function(a){a=a||{};this.sectionview_score=this.rich_score.cloneNode(!0);this.sectionplane={};var b=this.sectionview_score.querySelectorAll("app, choice"),c,d=this.sectionview_score,f=this.sectionplane,e=this.ALTs,g=this.xmlDoc,h,k,m;k=0;for(m=b.length;k<m;k++){h=b[k];var p=MeiLib.XMLID(h),n=a[p];if(n){c=n.xmlID;var q=C(d).find(n.tagname+
'[xml\\:id="'+c+'"]')[0];if(!q)throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+c+"'.");}else if(n=this.ALTs[p].getDefaultItem())c=n.xmlID,q=n.elem;var n=h.parentNode,l=g.createProcessingInstruction("MEI2VF",'rdgStart="'+p+'"');n.insertBefore(l,h);if(q){var l=q.childNodes,x;for(x=0;x<l.length;++x)n.insertBefore(l.item(x).cloneNode(!0),h)}l=g.createProcessingInstruction("MEI2VF",'rdgEnd="'+p+'"');n.insertBefore(l,
h);n.removeChild(h);f[p]=[];e[p].altitems[c]&&f[p].push(e[p].altitems[c])}return this.sectionview_score};MeiLib.MeiDoc.prototype.updateSectionView=function(a){var b,c,d=function(a,b){var c=0,d,f,e;for(e in a){f=a[e];var g=0,h=void 0;for(h in f)f[h]!==u&&f[h]===b[h]&&g++;f=g;c<f&&(c=f,d=a[e])}return d};for(b in a){var f=this.ALTs,e=[];"string"===typeof a[b]&&(a[b]=[a[b]]);var g;c=a[b].length;if(0<c)for(g=0;g<c;g++)e.push(f[b].altitems[a[b][g]]);else(g=this.ALTs[b].getDefaultItem())&&e.push(g);var h=
this.altgroups[b];if(h)for(g=0;g<h.length;g++){c=h[g];var k=[],m,p;m=0;for(p=e.length;m<p;m++)k.push(d(f[c].altitems,e[m]));this.replaceAltInstance({appXmlID:c,replaceWith:k})}else this.replaceAltInstance({appXmlID:b,replaceWith:e})}};MeiLib.MeiDoc.prototype.replaceAltInstance=function(a){var b=function(a,b){var c;for(c=0;c<b.length;++c)a.push(b.item(c));return a},c=a.appXmlID,d=C(this.sectionview_score).find("[xml\\:id="+this.ALTs[c].parentID+"]")[0];if("undefined"!==typeof d){var f=d.childNodes,
e=a.replaceWith,g=[],h=this.rich_score;if(e){var k;for(k=0;k<e.length;++k)var m=e[k],p=m.xmlID,m=C(h).find(m.tagname+'[xml\\:id="'+p+'"]')[0],g=b(g,m.childNodes)}var e=function(a,b){a=a.replace("'",'"');b=b.replace("'",'"');return a===b},m=h=!1,n=null;k=0;for(b=f.length;k<b;k++)p=f[k],7===p.nodeType?"MEI2VF"===p.nodeName&&e(p.nodeValue,'rdgStart="'+c+'"')?m=h=!0:"MEI2VF"===p.nodeName&&e(p.nodeValue,'rdgEnd="'+c+'"')&&(h=!1,n=p):h&&(d.removeChild(p),k--,b--);if(!m)throw"processing instruction not found";
if(h)throw"Unmatched <?MEI2VF rdgStart?>";f=n?function(a){d.insertBefore(a,n)}:function(a){d.appendChild(a)};k=0;for(b=g.length;k<b;k++)f(g[k].cloneNode(!0));this.sectionplane[c]=a.replaceWith;return this.sectionview_score}};MeiLib.MeiDoc.prototype.getSectionViewSlice=function(a){return MeiLib.SliceMEI(this.sectionview_score,a)};MeiLib.MeiDoc.prototype.getRichSlice=function(a){var b=new MeiLib.MeiDoc;b.xmlDoc=this.xmlDoc;b.rich_head=this.rich_head.cloneNode(!0);b.rich_music=this.rich_music.cloneNode(!0);
b.rich_score=MeiLib.SliceMEI(this.rich_score,a);b.sourceList=this.sourceList;b.editorList=this.editorList;b.ALTs=this.ALTs;b.altgroups=this.altgroups;return b};var r={attsToObj:function(a){var b,c={};if(a.hasAttributes())for(b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},pListToArray:function(a){return null!==a?a.split(" "):[]},serializeElement:function(a){var b="<"+a.localName,c,d,f;if(a.hasAttributes())for(d=a.attributes,a=0,c=d.length;a<c;a+=1)f=d.item(a),
b+=" "+f.nodeName+'="'+f.nodeValue+'"';return b+">"},isPlainObject:function(a){return"object"!==typeof a||a.nodeType||a.constructor&&!a.hasOwnProperty.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},extend:function(){var a,b,c,d,f,e=arguments[0]||{},g=1,h=arguments.length;for("object"!==typeof e&&"function"!==typeof e&&(e={});g<h;g++)if(null!=(a=arguments[g]))for(b in a)c=e[b],d=a[b],e!==d&&(d&&(r.isPlainObject(d)||(f=Array.isArray(d)))?(f?(f=!1,c=c&&Array.isArray(c)?c:[]):c=c&&r.isPlainObject(c)?
c:{},e[b]=r.extend(c,d)):d!==u&&(e[b]=d));return e},getText:function(a){var b,c="",d=0;b=a.nodeType;if(!b)for(;b=a[d++];)c+=this.getText(b);else if(1===b||9===b||11===b){if("string"===typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=this.getText(a)}else if(3===b||4===b)return a.nodeValue;return c},getNormalizedText:function(a){return r.getText(a).replace(/\s+/g," ")}};window.MeiLib||(window.MeiLib={});MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*
Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.durationOf=function(a,b,c){var d=c?function(a,b){return a.hasAttribute("grace")||"clef"===b}:function(a,b){return"clef"===b},f=function(a){return"note"===a||"rest"===a||"space"===a},e=function(a,b){var c=a.getAttribute("dur");c||(console.warn('@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified. Proceeding with default @dur="4". Element:'),console.log(a),c="4");return MeiLib.dotsMult(a)*MeiLib.dur2beats(Number(c),b)},g=function(a,
b,c){var d,f,e,g;c||(c="1");var h=a.getAttribute("dur"),k=MeiLib.dotsMult(a);if(h)return k*MeiLib.dur2beats(Number(h),b);e=a.childNodes;d=0;for(f=e.length;d<f;d++)if("note"===e[d].localName){g=e[d];var l=g.getAttribute("layer");if(!l||l===c)if(g=g.getAttribute("dur"),l=MeiLib.dotsMult(a),!h&&g)h=g,k=l;else if(h&&h!=g)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous. Element: "+r.serializeElement(a));}if(!h)throw new MeiLib.RuntimeError("MeiLib.durationOf:E06",
'@dur of chord must be specified either in <chord> or in at least one of its <note> elements. Proceeding with default @dur="4". Element:'+r.serializeElement(a));return k*MeiLib.dur2beats(Number(h),b)},h=function(a,b){var c=0,l,r,x,v;x=a.childNodes;l=0;for(r=x.length;l<r;l++){v=x[l];var t=v.localName;v=d(v,t)?0:f(t)?e(v,b):"chord"===t?g(v,b):"beam"===t?h(v,b):"tuplet"===t?k(v,b):0;c+=v}return c},k=function(a,b){var c=+a.getAttribute("num")||3,d=+a.getAttribute("numbase")||2;return h(a,{count:b.count,
unit:b.unit*d/c})};c=a.localName;return d(a,c)?0:f(c)?e(a,b):"mRest"===c?b.count:"chord"===c?g(a,b):"beam"===c?h(a,b):"tuplet"===c?k(a,b):0};MeiLib.tstamp2id=function(a,b,c){a=Number(a);var d=0,f=new MeiLib.EventEnumerator(b),e,g;b=null;for(var h;!f.EoI&&(g===u||0<g);)b=e,h=g,e=f.nextEvent(),g=a-(d+1),e.hasAttribute("grace")||"clef"===e.localName||(d+=MeiLib.durationOf(e,c,!0)*f.outputProportion.numbase/f.outputProportion.num);if(g===u)return u;c=0>g?b&&h<Math.abs(g)?b:e:e;var k=function(a){return a.hasAttribute("grace")||
"clef"===a.localName?k(f.nextEvent())||a:a};c=k(c);e=c.getAttribute("xml:id");e||(e=MeiLib.createPseudoUUID(),c.setAttribute("xml:id",e));return e};MeiLib.XMLID=function(a){var b=a.getAttribute("xml:id");b||(b=MeiLib.createPseudoUUID(),a.setAttribute("xml:id",b));return b};MeiLib.id2tstamp=function(a,b){for(var c,d=0;d<b.length;++d){b[d].meter&&(c=b[d].meter);if(0===d&&!c)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var f=MeiLib.sumUpUntil(a,b[d].layer,c);if(f.found)return d.toString()+
"m+"+(f.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+a+'" was found in the given MEI context.');};MeiLib.dur2beats=function(a,b){return b.unit/a};MeiLib.beats2dur=function(a,b){return b.unit/a};MeiLib.dotsMult=function(a){a=a.getAttribute("dots");a=Number(a||"0");for(var b=1;0<a;--a)b+=1/Math.pow(2,a);return b};MeiLib.sumUpUntil=function(a,b,c){var d=function(b){var e,g=null,h;h=b.localName;if(b.hasAttribute("grace")||"clef"===h)return{beats:0,
found:b.getAttribute("xml:id")===a};if("note"===h||"rest"===h){if(b.getAttribute("xml:id")===a)return{beats:0,found:!0};e=Number(b.getAttribute("dur"));if(!e)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");b.getAttribute("dots");e=MeiLib.dotsMult(b)*MeiLib.dur2beats(e,c);return{beats:e,found:!1}}if("mRest"===h)return b.getAttribute("xml:id")===a?{beats:0,found:!0}:{beats:c.count,found:!1};if("layer"===h||"beam"===h||"tuplet"===
h){e=0;b=b.childNodes;g=!1;for(h=0;h<b.length&&!g;++h)1===b[h].nodeType&&(g=d(b[h]),e+=g.beats,g=g.found);return{beats:e,found:g}}if("chord"===h){b.getAttribute("dur");if(b.getAttribute("xml:id")===a)return{beats:0,found:!0};if(h=b.getAttribute("dur"))return C(b).find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(h,c),found:g};b=b.childNodes;g=!1;for(h=0;h<b.length&&!g;++h)1===b[h].nodeType&&(g=d(b[h]),e=g.beats,g=g.found);return{beats:e,found:g}}return{beats:0,found:!1}};
return d(b)};var y=function(a){this.name="MEI2VF Runtime Error";this.message=a;this.stack=Error().stack};y.prototype=Error();var G=function(){},w={error:G,info:G,warn:G,debug:G,appender:{error:function(){window.console.error("MEI2VF ("+arguments[0]+"): "+Array.prototype.slice.call(arguments,1).join(" "))},info:function(){window.console.info("MEI2VF ("+arguments[0]+"): "+Array.prototype.slice.call(arguments,1).join(" "))},warn:function(){window.console.warn("MEI2VF ("+arguments[0]+"): "+Array.prototype.slice.call(arguments,
1).join(" "))},debug:function(){window.console.log("MEI2VF ("+arguments[0]+"): "+Array.prototype.slice.call(arguments,1).join(" "))}},setAppender:function(a){if("object"===typeof a){if("function"===typeof a.error&&"function"===typeof a.warn&&"function"===typeof a.info&&"function"===typeof a.debug)return this.appender=a,this;throw new y("Parameter object does not contain the expected appender methods.");}throw new y("Parameter is not an object");},setLevel:function(a){var b,c,d,f=!1;d=["debug","info",
"warn","error"];!0===a&&(f=!0);b=0;for(c=d.length;b<c;b+=1)d[b]===a&&(f=!0),this[d[b]]=f?this.appender[d[b]].bind(this.appender):G}},ga=function(a,b){this.notes_by_id=a;this.system_n=b;this.newBeamInfosToResolve=[];this.clefCheckQueue=[]};ga.prototype={startNewStave:function(a,b){this.stave=a;this.stave_n=b;this.inBeamNo=0;this.hasSpaceInBeam=this.hasStemDirInBeam=!1;this.graceNoteQueue=[];this.clefChangeInfo=null;this.beamInfosToResolve=this.newBeamInfosToResolve;this.newBeamInfosToResolve=[]},setLayerDir:function(a){this.layerDir=
a},getLayerDir:function(){return this.layerDir},setStaveN:function(a){this.stave_n=a},setStave:function(a){this.stave=a},getStave:function(){return this.stave},enterBeam:function(){this.inBeamNo+=1},exitBeam:function(){--this.inBeamNo;0===this.inBeamNo&&(this.hasSpaceInBeam=this.hasStemDirInBeam=!1)},addBeamInfoToResolve:function(a,b){this.newBeamInfosToResolve.push({element:a,vexNotes:b})},shiftBeamInfoToResolve:function(){return this.beamInfosToResolve.shift()},setSpaceInBeam:function(a){this.hasSpaceInBeam=
a},getSpaceInBeam:function(){return this.hasSpaceInBeam},setStemDirInBeam:function(a){this.hasStemDirInBeam=a},getStemDirInBeam:function(){return this.hasStemDirInBeam},isInBeam:function(){return 0<this.inBeamNo},addEvent:function(a,b){b.system=this.system_n;b.layerDir=this.layerDir;this.notes_by_id[a]=b},setClefChangeInfo:function(a){this.clefChangeInfo=a},getClefChangeInfo:function(){return this.clefChangeInfo},addToClefCheckQueue:function(a){this.clefCheckQueue.push(a)},emptyClefCheckQueue:function(){this.clefCheckQueue=
[]}};var L={n:"n",f:"b",s:"#",ff:"bb",ss:"##",x:"##"},H={"long":"1/4",breve:"1/2",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},M={above:l.Modifier.Position.ABOVE,below:l.Modifier.Position.BELOW},ta={cres:l.StaveHairpin.type.CRESC,dim:l.StaveHairpin.type.DECRESC},ua={acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},va={acc:"a>",stacc:"a.",ten:"a-",stacciss:"avb",marc:"a^b",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",
stroke:"a|"},ha={above:"a@a",below:"a@u"},E=function(a){this.init(a)};E.CATEGORY="articulations";Vex.Inherit(E,l.Articulation,{init:function(a){E.superclass.init.call(this,a);this.meiElement=[]},addMeiElement:function(a){this.meiElement.push(a);return this},getMeiElement:function(){return this.meiElement},draw:function(){null===this.position&&(this.position=this.note.getStemDirection()===l.StaveNote.STEM_DOWN?l.Modifier.Position.ABOVE:l.Modifier.Position.BELOW);E.superclass.draw.call(this)}});var t=
{DIR:{down:l.StaveNote.STEM_DOWN,up:l.StaveNote.STEM_UP},getVexPitch:function(a){var b,c;b=a.getAttribute("pname");c=a.getAttribute("oct");return b&&c?b+"/"+c:(w.warn("Missing attributes","@pname and @oct must be specified in "+r.serializeElement(a)+'". Setting default pitch c4.'),"c/4")},translateDuration:function(a,b){var c=H[b+""];if(!c){c={brevis:"breve",longa:"long"};if(c[b])return w.info("Not supported",'Duration "'+b+'" in '+r.serializeElement(a)+' is not supported. Using "'+c[b]+'" instead.'),
H[c[b]+""];if(b===u)throw new y("No duration attribute found in "+r.serializeElement(a));w.warn("Not supported",'Duration "'+b+' in "'+r.serializeElement(a)+'" is not supported. Using "4" instead.');c=H["4"]}return c},processAttsDuration:function(a,b){var c;c=this.translateDuration(a,b.dur);return"1"===b.dots?c+"d":"2"===b.dots?c+"dd":c},processAttrAccid:function(a,b,c){var d=L[a];d?b.addAccidental(c,new l.Accidental(d)):w.warn("Not supported",'The value "'+a+'" is not supported in @accid. Ignoring attribute.')},
processAttrHo:function(a,b,c){b.setExtraLeftPx(+a*c.getSpacingBetweenLines()/2)},addArticulation:function(a,b){var c,d,f,e,g,h;c=b.getAttribute("artic");if(null!==c){var k=c.split(" ");for(f=0;f<k.length;f++)if(h=b.getAttribute("place"),e="below"===h?va[k[f]]:ua[k[f]]){g=null;c=0;for(d=a.modifiers.length;c<d;c++)if(a.modifiers[c].type===e){g=a.modifiers[c];break}g?g.addMeiElement(b):(g=(new E(e)).addMeiElement(b),h?g.setPosition(M[h]):g.setPosition(null),a.addArticulation(0,g))}else w.info("unknown @artic",
"The @artic attribute in "+r.serializeElement(b)+" is unknown. Ignoring articulation.")}else w.warn("Missing attribute",r.serializeElement(b)+" does not have an @artic attribute. Ignoring articulation.")},addFermataAtt:function(a,b,c,d){this.addNewFermata(a,b,c,d,ha[c])},addFermata:function(a,b,c,d){var f,e,g=null,h;h=ha[c];f=0;for(e=a.modifiers.length;f<e;f++)if(a.modifiers[f].type===h){g=a.modifiers[f];break}g?g.addMeiElement(b):this.addNewFermata(a,b,c,d,h)},addNewFermata:function(a,b,c,d,f){f=
new E(f);f.setPosition(M[c]);f.addMeiElement(b);a.addArticulation(d||0,f)},addStemModifier:function(a,b,c){var d=parseInt(c,10);d?a.addArticulation(0,new l.Tremolo(d)):w.info("Not supported",'The value of @stem.mod="'+c+'" specified in '+r.serializeElement(b)+" is not supported. Ignoring attribute")},addClefModifier:function(a,b){var c=new l.ClefNote(b.type,"small",-1===b.shift?"8vb":u);c.setMeiElement(b.meiElement);a.addModifier(0,new l.GraceNoteGroup([c],!1));c.setOffsetLeft(25)},setStemDir:function(a,
b){var c=this.DIR[a.atts["stem.dir"]];if(c)return b.stem_direction=c,!0;a.layerDir?b.stem_direction=a.layerDir:b.auto_stem=!0;return!1},setCueSize:function(){this.render_options.glyph_font_scale=22;this.render_options.stem_height=20;this.render_options.stroke_px=2;this.glyph.head_width=6;this.buildNoteHeads();this.width=3}},N=function(a){var b,c,d=a.element,f=a.atts;c={keys:[a.vexPitch],duration:t.processAttsDuration(d,f),clef:a.clef.type,octave_shift:a.clef.shift};this.hasMeiStemDir=t.setStemDir(a,
c);l.StaveNote.call(this,c);"cue"===f.size&&t.setCueSize.call(this);b=+f.dots||0;for(c=0;c<b;c+=1)this.addDotToAll();this.setStave(a.stave);var e=d.childNodes;c=0;for(b=e.length;c<b;c++)switch(e[c].localName){case "accid":f.accid=e[c].getAttribute("accid");break;case "artic":t.addArticulation(this,e[c])}f.accid&&t.processAttrAccid(f.accid,this,0);f.artic&&t.addArticulation(this,d);f.ho&&t.processAttrHo(f.ho,this,a.stave);f.fermata&&t.addFermataAtt(this,d,f.fermata);f["stem.mod"]&&t.addStemModifier(this,
d,f["stem.mod"])};N.prototype=Object.create(l.StaveNote.prototype);N.prototype.beamable=!0;var O=function(a){var b,c,d=a.element,f=a.atts;c={keys:[a.vexPitch],duration:t.processAttsDuration(d,a.atts),clef:a.clef.type,octave_shift:a.clef.shift};this.hasMeiStemDir=t.setStemDir(a,c);l.GraceNote.call(this,c);b=+a.atts.dots||0;for(c=0;c<b;c+=1)this.addDotToAll();this.slash="1slash"===a.atts["stem.mod"];this.setStave(a.stave);var e=d.childNodes;c=0;for(b=e.length;c<b;c++)switch(e[c].localName){case "accid":f.accid=
e[c].getAttribute("accid");break;case "artic":t.addArticulation(this,e[c])}f.accid&&t.processAttrAccid(f.accid,this,0);f.artic&&t.addArticulation(this,d);f.ho&&t.processAttrHo(f.ho,this,a.stave);f.fermata&&t.addFermataAtt(this,d,f.fermata)};O.prototype=Object.create(l.GraceNote.prototype);O.prototype.grace=!0;var P=function(a){var b=a.atts,c=a.element,d=[],f=[],e,g,h,k;h=a.noteElements;if(b.dur)for(d=t.processAttsDuration(c,b),k=+b.dots||0,e=0,g=h.length;e<g;e+=1)f.push(t.getVexPitch(h[e]));else{e=
0;for(g=h.length;e<g;e+=1)d.push(+h[e].getAttribute("dur")),k=+h[e].getAttribute("dots")||0,f.push(t.getVexPitch(h[e]));d=t.translateDuration(c,Math.max.apply(Math,d));for(e=0;e<k;e+=1)d+="d"}e={keys:f,duration:d,clef:a.clef.type,octave_shift:a.clef.shift};this.hasMeiStemDir=t.setStemDir(a,e);l.StaveNote.call(this,e);"cue"===b.size&&t.setCueSize.call(this);for(e=0;e<k;e+=1)this.addDotToAll();this.setStave(a.stave);b.ho&&t.processAttrHo(b.ho,this,a.stave);a=c.getElementsByTagName("artic");e=0;for(g=
a.length;e<g;e++)t.addArticulation(this,a[e]);b.artic&&t.addArticulation(this,c);b.fermata&&t.addFermataAtt(this,c,b.fermata);b["stem.mod"]&&t.addStemModifier(this,c,b["stem.mod"])};P.prototype=Object.create(l.StaveNote.prototype);P.prototype.beamable=!0;var Q=function(a){var b=a.atts,c=a.element,d=[],f=[],e,g,h,k;h=a.noteElements;if(b.dur)for(d=t.processAttsDuration(c,b),k=+b.dots||0,e=0,g=h.length;e<g;e+=1)f.push(t.getVexPitch(h[e]));else{e=0;for(g=h.length;e<g;e+=1)d.push(+h[e].getAttribute("dur")),
k=+h[e].getAttribute("dots")||0,f.push(t.getVexPitch(h[e]));d=t.translateDuration(c,Math.max.apply(Math,d));for(e=0;e<k;e+=1)d+="d"}e={keys:f,duration:d,clef:a.clef.type,octave_shift:a.clef.shift};this.hasMeiStemDir=t.setStemDir(a,e);l.GraceNote.call(this,e);for(e=0;e<k;e+=1)this.addDotToAll();this.slash="1slash"===b["stem.mod"];this.setStave(a.stave);b.ho&&t.processAttrHo(b.ho,this,a.stave);a=c.getElementsByTagName("artic");e=0;for(g=a.length;e<g;e++)t.addArticulation(this,a[e]);b.artic&&t.addArticulation(this,
c);b.fermata&&t.addFermataAtt(this,c,b.fermata)};Q.prototype=Object.create(l.GraceNote.prototype);Q.prototype.grace=!0;var R=function(a){var b,c,d;d=r.attsToObj(a.element);b=t.processAttsDuration(a.element,d)+"r";a.clef?(b={duration:b,keys:[d.ploc+"/"+d.oloc],clef:a.clef.type,octave_shift:a.clef.shift},this.manualPosition=!0):b={duration:b,keys:["1"===d.dur?"d/5":"b/4"]};l.StaveNote.call(this,b);"cue"===d.size&&t.setCueSize.call(this);b=+d.dots||0;for(c=0;c<b;c+=1)this.addDotToAll();this.setStave(a.stave);
d.ho&&t.processAttrHo(d.ho,this,a.stave);d.fermata&&t.addFermataAtt(this,a.element,d.fermata)};R.prototype=Object.create(l.StaveNote.prototype);R.prototype.beamable=!0;var S=function(a){var b,c,d;d=r.attsToObj(a.element);b=new l.Fraction(a.meter.count,a.meter.unit);var f;2==b.value()?(c=H.breve,f=["b/4"]):4==b.value()?(c=H["long"],f=["b/4"]):(c="w",f=["d/5"]);l.StaveNote.call(this,a.clef?{align_center:!0,duration:c+"r",duration_override:b,keys:[d.ploc+"/"+d.oloc],clef:a.clef.type,octave_shift:a.clef.shift}:
{align_center:!0,duration:c+"r",duration_override:b,keys:f});"cue"===d.size&&t.setCueSize.call(this);b=+d.dots||0;for(c=0;c<b;c+=1)this.addDotToAll();this.setStave(a.stave);d.ho&&t.processAttrHo(d.ho,this,a.stave);d.fermata&&t.addFermataAtt(this,a.element,d.fermata)};S.prototype=Object.create(l.StaveNote.prototype);S.prototype.beamable=!0;var I=function(a){var b;b=r.attsToObj(a.element);b={duration:t.processAttsDuration(a.element,b)+"r"};l.GhostNote.call(this,b);this.setStave(a.stave)};I.prototype=
Object.create(l.GhostNote.prototype);I.prototype.beamable=!0;window.MeiLib||(window.MeiLib={});MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};MeiLib.durationOf=function(a,b,c){var d=c?function(a,b){return a.hasAttribute("grace")||"clef"===b}:function(a,b){return"clef"===b},f=function(a){return"note"===a||"rest"===a||"space"===a},e=function(a,b){var c=a.getAttribute("dur");c||(console.warn('@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified. Proceeding with default @dur="4". Element:'),
console.log(a),c="4");return MeiLib.dotsMult(a)*MeiLib.dur2beats(Number(c),b)},g=function(a,b,c){var d,f,e,g;c||(c="1");var h=a.getAttribute("dur"),k=MeiLib.dotsMult(a);if(h)return k*MeiLib.dur2beats(Number(h),b);e=a.childNodes;d=0;for(f=e.length;d<f;d++)if("note"===e[d].localName){g=e[d];var l=g.getAttribute("layer");if(!l||l===c)if(g=g.getAttribute("dur"),l=MeiLib.dotsMult(a),!h&&g)h=g,k=l;else if(h&&h!=g)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous. Element: "+
r.serializeElement(a));}if(!h)throw new MeiLib.RuntimeError("MeiLib.durationOf:E06",'@dur of chord must be specified either in <chord> or in at least one of its <note> elements. Proceeding with default @dur="4". Element:'+r.serializeElement(a));return k*MeiLib.dur2beats(Number(h),b)},h=function(a,b){var c=0,l,r,x,v;x=a.childNodes;l=0;for(r=x.length;l<r;l++){v=x[l];var t=v.localName;v=d(v,t)?0:f(t)?e(v,b):"chord"===t?g(v,b):"beam"===t?h(v,b):"tuplet"===t?k(v,b):0;c+=v}return c},k=function(a,b){var c=
+a.getAttribute("num")||3,d=+a.getAttribute("numbase")||2;return h(a,{count:b.count,unit:b.unit*d/c})};c=a.localName;return d(a,c)?0:f(c)?e(a,b):"mRest"===c?b.count:"chord"===c?g(a,b):"beam"===c?h(a,b):"tuplet"===c?k(a,b):0};MeiLib.tstamp2id=function(a,b,c){a=Number(a);var d=0,f=new MeiLib.EventEnumerator(b),e,g;b=null;for(var h;!f.EoI&&(g===u||0<g);)b=e,h=g,e=f.nextEvent(),g=a-(d+1),e.hasAttribute("grace")||"clef"===e.localName||(d+=MeiLib.durationOf(e,c,!0)*f.outputProportion.numbase/f.outputProportion.num);
if(g===u)return u;c=0>g?b&&h<Math.abs(g)?b:e:e;var k=function(a){return a.hasAttribute("grace")||"clef"===a.localName?k(f.nextEvent())||a:a};c=k(c);e=c.getAttribute("xml:id");e||(e=MeiLib.createPseudoUUID(),c.setAttribute("xml:id",e));return e};MeiLib.XMLID=function(a){var b=a.getAttribute("xml:id");b||(b=MeiLib.createPseudoUUID(),a.setAttribute("xml:id",b));return b};MeiLib.id2tstamp=function(a,b){for(var c,d=0;d<b.length;++d){b[d].meter&&(c=b[d].meter);if(0===d&&!c)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001",
"No time signature specified");var f=MeiLib.sumUpUntil(a,b[d].layer,c);if(f.found)return d.toString()+"m+"+(f.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+a+'" was found in the given MEI context.');};MeiLib.dur2beats=function(a,b){return b.unit/a};MeiLib.beats2dur=function(a,b){return b.unit/a};MeiLib.dotsMult=function(a){a=a.getAttribute("dots");a=Number(a||"0");for(var b=1;0<a;--a)b+=1/Math.pow(2,a);return b};MeiLib.sumUpUntil=function(a,b,c){var d=
function(b){var e,g=null,h;h=b.localName;if(b.hasAttribute("grace")||"clef"===h)return{beats:0,found:b.getAttribute("xml:id")===a};if("note"===h||"rest"===h){if(b.getAttribute("xml:id")===a)return{beats:0,found:!0};e=Number(b.getAttribute("dur"));if(!e)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");b.getAttribute("dots");e=MeiLib.dotsMult(b)*MeiLib.dur2beats(e,c);return{beats:e,found:!1}}if("mRest"===h)return b.getAttribute("xml:id")===
a?{beats:0,found:!0}:{beats:c.count,found:!1};if("layer"===h||"beam"===h||"tuplet"===h){e=0;b=b.childNodes;g=!1;for(h=0;h<b.length&&!g;++h)1===b[h].nodeType&&(g=d(b[h]),e+=g.beats,g=g.found);return{beats:e,found:g}}if("chord"===h){b.getAttribute("dur");if(b.getAttribute("xml:id")===a)return{beats:0,found:!0};if(h=b.getAttribute("dur"))return C(b).find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(h,c),found:g};b=b.childNodes;g=!1;for(h=0;h<b.length&&!g;++h)1===b[h].nodeType&&
(g=d(b[h]),e=g.beats,g=g.found);return{beats:e,found:g}}return{beats:0,found:!1}};return d(b)};var T=function(a){this.xmlid=a};T.prototype={setId:function(a){this.xmlid=a},setTStamp:function(a){this.tstamp=a;this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){if(!this.tstamp)throw new y("tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(a){a&&a.meicontext&&
this.setContext(a.meicontext);return this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(a&&a.strict),this.xmlid):null},setContext:function(a){this.meicontext=a}};var F=function(a,b){this.init(a,b)};F.prototype={init:function(a,b){this.first_ref=new T(a);this.last_ref=new T(b);this.params={}},setParams:function(a){this.params=a},setMeiElement:function(a){this.meiElement=a},getMeiElement:function(){return this.meiElement},setFirstRef:function(a){this.first_ref=a},setLastRef:function(a){this.last_ref=
a},setFirstId:function(a){this.first_ref.setId(a)},setLastId:function(a){this.last_ref.setId(a)},setFirstTStamp:function(a){this.first_ref.setTStamp(a)},setLastTStamp:function(a){this.last_ref.setTStamp(a)},setContext:function(a){this.meicontext=a},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}};var A=function(a,b){this.init(a,b)};A.prototype={init:function(a,b){this.allVexObjects=[];this.allModels=
[];this.systemInfo=a;this.unresolvedTStamp2=b},validateAtts:function(){throw new y("You have to provide a validateAtts() method when inheriting MEI2VF.EventLinkCollection.");},createVexFromInfos:function(){throw new y("You have to provide a createVexFromInfos method when inheriting MEI2VF.EventLinkCollection.");},createInfos:function(a,b,c,d){var f=function(a){return{stave_n:a.getAttribute("staff")||"1",layer_n:a.getAttribute("layer")||"1"}},e=function(a,b,c){var e=f(b),g=c.querySelector('staff[n="'+
e.stave_n+'"]');if(!g)throw new y('Cannot find staff @n="'+e.stave_n+'" in '+r.serializeElement(c));b=g.querySelector('layer[n="'+e.layer_n+'"]');if(!b&&((g=g.getElementsByTagName("layer")[0])&&!g.hasAttribute("n")&&(b=g),!b))throw new y('Cannot find layer @n="'+e.layer_n+'" in '+r.serializeElement(c));c=d.getStaveInfo(e.stave_n);if(!c)throw new y("Cannot determine staff definition.");c=c.getTimeSpec();if(!c.count||!c.unit)throw new y("Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");
return MeiLib.tstamp2id(a,b,c)},g,h,k,m,l,n;g=0;for(h=a.length;g<h;g++){m=a[g];k=new F(null,null);l=r.attsToObj(m);this.validateAtts(l);k.setParams(l);k.setMeiElement(m);if(n=l.startid)k.setFirstId(n.substring(1));else if(n=l.tstamp)n=e(n,m,b),k.setFirstId(n);if(n=l.endid)k.setLastId(n.substring(1));else if(n=l.tstamp2)l=+n.substring(0,n.indexOf("m")),0<l?(k.setLastTStamp(n.substring(n.indexOf("+")+1)),m=f(m),m=c+l+":"+m.stave_n+":"+m.layer_n,this.unresolvedTStamp2[m]||(this.unresolvedTStamp2[m]=
[]),this.unresolvedTStamp2[m].push(k)):(n=e(n.substring(n.indexOf("+")+1),m,b),k.setLastId(n));this.addModel(k)}},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels},setContext:function(a){this.ctx=a;return this},draw:function(){var a=this.ctx,b,c,d=this.allVexObjects;b=0;for(c=d.length;b<c;b++)d[b].setContext(a).draw()}};var U=function(a,b){this.init(a,b)};Vex.Inherit(U,A,{init:function(a,b){U.superclass.init.call(this,a,b)},validateAtts:function(a){if(!a.form)throw new y("@form is mandatory in <hairpin> - make sure the xml is valid.");
},createVexFromInfos:function(a){var b,c,d,f,e;d=0;for(f=this.allModels.length;d<f;d++)e=this.allModels[d],b=a[e.getFirstId()]||{},c=a[e.getLastId()]||{},b.system!==u&&c.system!==u&&b.system!==c.system?(this.createSingleHairpin(b,{},e.params,e.getMeiElement()),this.createSingleHairpin({},c,e.params,e.getMeiElement())):this.createSingleHairpin(b,c,e.params,e.getMeiElement());return this},createSingleHairpin:function(a,b,c,d){var f,e;f=M[c.place];e=ta[c.form];if(!a.vexNote&&!b.vexNote){var g;d="";for(g in c)d+=
g+'="'+c[g]+'" ';console.log(c);w.warn("Hairpin could not be processed","No haipin start or hairpin end could be found. Hairpin parameters: "+d+". Skipping hairpin.");return!0}c=new l.StaveHairpin({first_note:a.vexNote,last_note:b.vexNote},e);c.setRenderOptions({height:10,y_shift:0,left_shift_px:0,right_shift_px:0});c.setPosition(f);c.setMeiElement(d);this.allVexObjects.push(c)}});var V=function(a,b){this.init(a,b)};Vex.Inherit(V,A,{init:function(a,b){V.superclass.init.call(this,a,b)},validateAtts:function(){},
startTie:function(a,b){var c=new F(a,null);c.setParams({linkCond:b});this.allModels.push(c)},terminateTie:function(a,b){var c,d,f,e,g;g=this.getModels();c=function(a,b){return a&&b&&a.vexPitch===b.vexPitch&&a.stave_n===b.stave_n};d=!1;for(f=0;!d&&f<g.length;++f)e=g[f],!e.getLastId()&&c(e.params.linkCond,b)&&(d=!0,e.setLastId(a));d||this.addModel(new F(null,a))},createVexFromInfos:function(a){var b,c,d,f,e;d=0;for(f=this.allModels.length;d<f;d++){e=this.allModels[d];var g;b=a[e.getFirstId()]||{};c=
a[e.getLastId()]||{};if(!b.vexNote&&!c.vexNote){var h;a="";for(h in e.params)a+=h+'="'+e.params[h]+'" ';console.log(e);w.warn("Tie could not be processed","No tie start or tie end could be found. Tie parameters: "+a+". Skipping tie.");return!0}e.params.curvedir||((g=b.layerDir||c.layerDir)?e.params.curvedir=-1===g?"below":1===g?"above":u:b.vexNote?(g=b.vexNote.keys.length,1<g&&(e.params.curvedir=0===+b.index?"below":+b.index===g-1?"above":u)):c.vexNote&&(g=c.vexNote.keys.length,1<g&&(e.params.curvedir=
0===+c.index?"below":+c.index===g-1?"above":u)));b.system!==u&&c.system!==u&&b.system!==c.system?(this.createSingleTie(b,{},e.params),e.params.curvedir||(e.params.curvedir=-1===b.vexNote.getStemDirection()?"above":"below"),this.createSingleTie({},c,e.params)):this.createSingleTie(b,c,e.params)}return this},createSingleTie:function(a,b,c){b=new l.StaveTie({first_note:a.vexNote,last_note:b.vexNote,first_indices:a.index,last_indices:b.index});c.curvedir&&b.setDir("above"===c.curvedir?-1:1);a.vexNote&&
!0===a.vexNote.grace&&(b.render_options.first_x_shift=-5);this.allVexObjects.push(b)}});var W=function(a,b){this.init(a,b)};Vex.Inherit(W,A,{init:function(a,b){W.superclass.init.call(this,a,b)},validateAtts:function(){},startSlur:function(a,b){var c=new F(a,null);c.setParams({linkCond:b});this.allModels.push(c)},terminateSlur:function(a,b){var c,d,f,e,g=this.getModels();c=function(a,b){return a.nesting_level===b.nesting_level};d=!1;for(f=0;f<g.length;++f)if((e=g[f])&&!e.getLastId()&&c(e.params.linkCond,
b)){e.setLastId(a);d=!0;break}d||this.addModel(new F(null,a))},createVexFromInfos:function(a){var b,c,d,f,e,g,h,k,m={};d=0;for(f=this.allModels.length;d<f;d++){e=this.allModels[d];g=e.params;h="above"===g.curvedir?1:"below"===g.curvedir?-1:null;b=a[e.getFirstId()]||{};c=a[e.getLastId()]||{};if(!b.vexNote&&!c.vexNote){var p;a="";for(p in g)a+=p+'="'+g[p]+'" ';console.log(e);w.warn("Slur could not be processed","No slur start or slur end could be found. Slur parameters: "+a+". Skipping slur.");return!0}var n,
q;b.vexNote&&(n=b.vexNote.getStemDirection());c.vexNote&&(q=c.vexNote.getStemDirection());k=b.layerDir||c.layerDir;e=n||q;h||(h=k?k:-1*e);m.invert=!(-1===h&&1===q||1===h&&-1===q);k=parseFloat(g.startvo);g=parseFloat(g.endvo);k=null,b.vexNote&&c.vexNote&&b.vexNote.hasStem()&&c.vexNote.hasStem()?n!==q&&n&&q?e===h?(m.position=l.Curve.Position.NEAR_TOP,m.position_end=l.Curve.Position.NEAR_HEAD):(m.position=l.Curve.Position.NEAR_HEAD,m.position_end=l.Curve.Position.NEAR_TOP):e===h?(m.position=l.Curve.Position.NEAR_TOP,
m.position_end=l.Curve.Position.NEAR_TOP):(m.position=l.Curve.Position.NEAR_HEAD,m.position_end=l.Curve.Position.NEAR_HEAD):(m.position=l.Curve.Position.NEAR_HEAD,m.position_end=l.Curve.Position.NEAR_HEAD);b.system!==u&&c.system!==u&&b.system!==c.system?(this.createSingleSlur(b,{},{y_shift_start:m.y_shift_start,y_shift_end:m.y_shift_end,invert:1===h&&1===n||-1===h&&-1===n,position:m.position,position_end:m.position}),m.position=m.position_end,m.invert=1===h&&1===q||-1===h&&-1===q,this.createSingleSlur({},
c,m)):this.createSingleSlur(b,c,m)}return this},createSingleSlur:function(a,b,c){this.allVexObjects.push(new l.Curve(a.vexNote,b.vexNote,c))},bezierStringToCps:function(a){var b=[],c,d;for(c=/(\-?[\d|\.]+)\s+(\-?[\d|\.]+)/g;d=c.exec(a);)b.push({x:+d[1],y:+d[2]});b[1]||(w.info("Incomplete attribute","Expected four control points in slur/@bezier, but only found two. Providing cps 3 & 4 on basis on cps 1 & 2."),b[1]={x:-b[0].x,y:b[0].y});return b}});A=function(a,b){this.init(a,b)};A.prototype={BOTTOM:l.Annotation.VerticalJustify.BOTTOM,
init:function(a,b){this.allVexObjects=[];this.allModels=[];this.systemInfo=a;this.font=b},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels},createInfos:function(a,b){var c,d,f,e,g;c=0;for(d=a.length;c<d;c++){f=a[c];e=r.attsToObj(f);if(g=e.startid)g=g.substring(1);else if(g=e.tstamp){var h=f,k=b,m=void 0,l=void 0,m=h.getAttribute("staff")||"1",l=h.getAttribute("layer")||"1",n=k.querySelector('staff[n="'+m+'"]');if(!n)throw new y('Could not find staff @n="'+m+
'" in '+r.serializeElement(k)+" while processing "+r.serializeElement(h));var q=n.querySelector('layer[n="'+l+'"]');if(!q&&((n=n.getElementsByTagName("layer")[0])&&!n.hasAttribute("n")&&(q=n),!q))throw new y('Could not find layer @n="'+l+'" in '+r.serializeElement(k)+" while processing "+r.serializeElement(h));h=this.systemInfo.getStaveInfo(m);if(!h)throw new y("Cannot determine staff definition.");h=h.getTimeSpec();if(!h.count||!h.unit)throw new y("Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");
g=MeiLib.tstamp2id(g,q,h)}else{w.warn("@startid or @tstamp expected",r.serializeElement(f)+" could not be processed because neither @startid nor @tstamp are specified.");break}this.allModels.push({element:f,atts:e,startid:g})}},createVexFromInfos:function(a){var b,c,d;for(b=this.allModels.length;b--;)c=this.allModels[b],(d=a[c.startid])?this.addToNote(c,d):c.startid?w.warn("Unknown reference",r.serializeElement(c.element)+' could not be processed because the reference "'+c.startid+'" could not be resolved.'):
w.warn("Unknown reference",r.serializeElement(c.element)+" could not be processed because it could not be assigned to an element.")},addToNote:function(){throw new y("You have to provide an addToNote() method when inheriting MEI2VF.EventPointerCollection.");}};var X=function(a){this.init(a)};Vex.Inherit(X,A,{init:function(a,b){X.superclass.init.call(this,a,b)},createInfos:function(a,b){var c,d,f,e,g;c=0;for(d=a.length;c<d;c++){f=a[c];e=r.attsToObj(f);var h;e.plist&&(h=r.pListToArray(e.plist));if(h&&
h[0])g=h[0].substring(1);else if(g=e.tstamp){var k=f,m=b,l=void 0,n=void 0,l=k.getAttribute("staff")||"1",n=k.getAttribute("layer")||"1",q=m.querySelector('staff[n="'+l+'"]');if(!q)throw new y('Could not find staff @n="'+l+'" in '+r.serializeElement(m)+" while processing "+r.serializeElement(k));var t=q.querySelector('layer[n="'+n+'"]');if(!t&&((q=q.getElementsByTagName("layer")[0])&&!q.hasAttribute("n")&&(t=q),!t))throw new y('Could not find layer @n="'+n+'" in '+r.serializeElement(m)+" while processing "+
r.serializeElement(k));k=this.systemInfo.getStaveInfo(l);if(!k)throw new y("Cannot determine staff definition.");k=k.getTimeSpec();if(!k.count||!k.unit)throw new y("Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");g=MeiLib.tstamp2id(g,t,k)}else{w.warn("@startid or @tstamp expected",r.serializeElement(f)+" could not be processed because neither @startid nor @tstamp are specified.");break}this.allModels.push({element:f,atts:e,startid:g})}},addToNote:function(a,b){b.vexNote.addStroke(0,
new l.Stroke(0))}});var Y=function(a,b){this.init(a,b)};Vex.Inherit(Y,A,{init:function(a,b){Y.superclass.init.call(this,a,b)},addToNote:function(a,b){var c,d,f,e;c=this.font.family;d=this.font.size;f="";if(e=a.element.getElementsByTagName("rend")[0])e=r.attsToObj(e),e.fontfamily&&(c=e.fontfamily),e.fontweight&&(f+=e.fontweight+" "),e.fontstyle&&(f+=e.fontstyle),e.fontsize&&(d=1.5*+e.fontsize);c=(new l.Annotation(r.getNormalizedText(a.element).trim())).setFont(c,d,f).setMeiElement(a.element);c.setWidth(0);
c.setJustification(1);"below"===a.atts.place?b.vexNote.addAnnotation(0,c.setVerticalJustification(this.BOTTOM)):b.vexNote.addAnnotation(0,c)}});var Z=function(a,b){this.init(a,b)};Vex.Inherit(Z,A,{init:function(a,b){Z.superclass.init.call(this,a,b)},addToNote:function(a,b){var c=(new l.Annotation(r.getText(a.element).trim())).setFont(this.font.family,this.font.size,this.font.weight).setMeiElement(a.element);c.setWidth(0);"above"===a.atts.place?b.vexNote.addAnnotation(0,c):b.vexNote.addAnnotation(0,
c.setVerticalJustification(this.BOTTOM))}});var aa=function(a,b){this.init(a,b)};Vex.Inherit(aa,A,{init:function(a,b){aa.superclass.init.call(this,a,b)},addToNote:function(a,b){t.addFermata(b.vexNote,a.element,a.atts.place)}});var ba=function(a,b){this.init(a,b)};Vex.Inherit(ba,A,{init:function(a,b){ba.superclass.init.call(this,a,b)},addToNote:function(a,b){var c=a.atts,d={trill:"tr",mordent:"mordent",turn:"turn"}[a.element.localName],d=new l.Ornament(d+("mordent"===d?"inv"===c.form?"":"_inverted":
"inv"===c.form?"_inverted":""));d.setMeiElement(a.element);c.accidupper&&d.setUpperAccidental(L[c.accidupper]);c.accidlower&&d.setLowerAccidental(L[c.accidlower]);b.vexNote.addModifier(0,d)}});A=function(){};A.prototype={init:function(){this.spanElements=[];this.vexObjects=[]},addSpanElements:function(a){this.spanElements.push(a)},addVexObject:function(a){this.vexObjects.push(a)},resolveSpans:function(a,b,c){var d,f,e,g,h,k;d=0;for(f=a.length;d<f;d++)if(e=a[d],g=e.getAttribute("plist"),g=r.pListToArray(g),
h=e.getAttribute("startid"),k=e.getAttribute("endid"),null!==h||null!==k){g[0]!==h&&g.unshift(h);g[g.length-1]!==k&&g.push(k);var m=[],p;g=g.map(function(a,b){var d=c[a.substring(1)];if(!d)throw new y('Reference "'+a+'" given in '+r.serializeElement(e)+" not found.");var f=d.vexNote.voice;0===b&&(p=C(d.meiNote).closest("measure").get(0));var g=m.indexOf(f);-1===g&&(p&&C(d.meiNote).closest("measure").get(0)!==p||(g=m.push(f)-1));return{obj:d,voiceIndex:g,vexNote:d.vexNote}});var n;h=function(a,b){var c=
new l.GhostNote(a.getDuration());c.setStave(b);return c};k=g.map(function(a){return a.vexNote});var q,t;if(1<m.length)for(var x=0,v=m.length;x<v;x++){q=[];t=[];for(var u=0,sa=g.length;u<sa;u++)g[u].voiceIndex===x?(q[u]=g[u].vexNote,t.push(m[x].tickables.indexOf(g[u].vexNote))):-1!==g[u].voiceIndex&&(n=h(g[u].vexNote,m[x].tickables[0].stave),q[u]=n);n=m[x].tickables;0!==x&&"function"===typeof b&&b(e,q);m[x].tickables=n.slice(0,t[0]).concat(q).concat(n.slice(t[t.length-1]+1))}this.createVexObject(k,
m,e)}else w.warn("Missing attributes","Could not process "+r.serializeElement(e)+", because @startid or @endid is missing.")},createVexObject:function(){throw new y("createVexObject() method not implemented.");},postFormat:function(){var a,b,c=this.vexObjects;a=0;for(b=c.length;a<b;a++)c[a].postFormat()},setContext:function(a){this.ctx=a;return this},draw:function(){var a,b,c=this.vexObjects,d=this.ctx;a=0;for(b=c.length;a<b;a++)c[a].setContext(d).draw()}};var ca=function(){this.init()};Vex.Inherit(ca,
A,{init:function(){ca.superclass.init.call(this)},resolveSpanElements:function(a){this.resolveSpans(this.spanElements,null,a)},createVexObject:function(a){this.vexObjects.push(new l.Beam(a,!1))}});var da=function(){this.init()};Vex.Inherit(da,A,{init:function(){da.superclass.init.call(this)},resolveSpanElements:function(a){this.resolveSpans(this.spanElements,function(a,c){new l.Tuplet(c,{num_notes:parseInt(a.getAttribute("num"),10)||3,beats_occupied:parseInt(a.getAttribute("numbase"),10)||2})},a)},
createVexObject:function(a,b,c){var d,f;a=new l.Tuplet(a,{num_notes:parseInt(c.getAttribute("num"),10)||3,beats_occupied:parseInt(c.getAttribute("numbase"),10)||2});"ratio"===c.getAttribute("num.format")&&a.setRatioed(!0);a.setBracketed("true"===c.getAttribute("bracket.visible"));(c=c.getAttribute("bracket.place"))&&a.setTupletLocation("above"===c?1:-1);this.vexObjects.push(a);d=0;for(f=b.length;d<f;d++)a=b[d],c=a.tickables,a.ticksUsed=new Vex.Flow.Fraction(0,1),a.tickables=[],a.addTickables(c)}});
var ea=function(a,b){this.allSyllables=[];this.font=a;this.maxHyphenDistance=b};ea.prototype={WORD_SEPARATOR:null,addSyllable:function(a,b){"i"===b&&this.allSyllables.push(this.WORD_SEPARATOR);this.allSyllables.push(a);"t"===b&&this.allSyllables.push(this.WORD_SEPARATOR)},setContext:function(a){this.ctx=a;return this},draw:function(a,b){var c,d,f,e;this.ctx.setFont(this.font.family,this.font.size,this.font.weight);e=this.ctx.measureText("-").width;for(c=this.allSyllables.length+1;c--;)if(d=this.allSyllables[c-
1],f=this.allSyllables[c],d!==this.WORD_SEPARATOR&&f!==this.WORD_SEPARATOR){var g={hyphen_width:e,max_hyphen_distance:this.maxHyphenDistance};g.first_annot=d===u?{x:a}:d;g.last_annot=f===u?{x:b}:f;(g.first_annot.y||g.last_annot.y)&&(new l.Hyphen(g)).setContext(this.ctx).renderHyphen()}}};var J=function(a){this.systemVerses={};this.lowestYs={};this.font=a.font;this.maxHyphenDistance=a.maxHyphenDistance};J.prototype={addSyllable:function(a,b,c){var d=b.getAttribute("wordpos");b=b.parentNode;b="verse"===
b.localName&&b.hasAttribute("n")?b.getAttribute("n"):"1";this.systemVerses[c]||(this.systemVerses[c]={});this.systemVerses[c][b]||(this.systemVerses[c][b]={syllables:[],hyphenation:this.newHyphenation()});this.systemVerses[c][b].syllables.push(a);d&&this.systemVerses[c][b].hyphenation.addSyllable(a,d);return this},getLowestYs:function(){return this.lowestYs},getLowestY:function(a){return this.lowestYs[a]},newHyphenation:function(){return new ea(this.font,this.maxHyphenDistance)},format:function(){var a,
b,c,d,f,e,g;this.font.size=15;for(a in this.systemVerses){e=-20;for(b in this.systemVerses[a]){c=this.systemVerses[a][b].syllables;e+=20;d=0;for(f=c.length;d<f;d++)c[d].setTextLine(0),g=c[d].getModifierContext().modifiers.stavenotes,1<g.length&&c[d].setNote(g[0]),e=Math.max(e,c[d].preProcess());for(d=0;d<f;d++)c[d].setY(e)}this.lowestYs[a]=e}return this},drawHyphens:function(a,b,c){var d,f;for(d in this.systemVerses)for(f in this.systemVerses[d])this.systemVerses[d][f].hyphenation.setContext(a).draw(b,
c);return this}};var z=function(a,b,c){this.init(a);this.setFont(c.family,c.size,c.weight);this.setMeiElement(b);this.setLineSpacing(c.spacing)};z.CATEGORY="annotations";z.DEFAULT_FONT_SIZE=10;z.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4};z.VerticalJustify={TOP:1,BOTTOM:3};z.format=function(a,b){if(!a||0===a.length)return!1;for(var c=b.text_line,d,f=0;f<a.length;++f)d=a[f],d.setTextLine(c),d=0<d.getWidth()?d.getWidth():0,c++;b.left_shift+=d/2;b.right_shift+=d/2;return!0};var ia=l.Modifier;Vex.Inherit(z,
ia,{init:function(a){z.superclass.init.call(this);this.index=this.note=null;this.text_line=0;this.text=a;this.justification=z.Justify.CENTER;this.vert_justification=z.VerticalJustify.BOTTOM;this.font={family:"Arial",size:z.DEFAULT_FONT_SIZE,weight:""};this.line_spacing=1.1;this.setWidth(l.textWidth(a))},setMeiElement:function(a){this.meiElement=a;return this},getMeiElement:function(){return this.meiElement},setLineSpacing:function(a){this.line_spacing=a;return this},setTextLine:function(a){this.text_line=
a;return this},setFont:function(a,b,c){this.font={family:a,size:b,weight:c};return this},setVerticalJustification:function(a){this.vert_justification=a;return this},getJustification:function(){return this.justification},setJustification:function(a){this.justification=a;return this},preProcess:function(){var a,b,c,d=this.note.hasStem(),f=this.note.getStave();d&&(b=this.note.getStem().getExtents(),c=f.getSpacingBetweenLines());var e=this.font.size/z.DEFAULT_FONT_SIZE*this.line_spacing;this.vert_justification==
z.VerticalJustify.BOTTOM?(a=f.getYForBottomText(this.text_line),d&&(b=1===this.note.getStemDirection()?b.baseY+10:b.topY+5,a=Math.max(a,b+(c*(this.text_line+1)*e+c*this.text_line)))):this.vert_justification==z.VerticalJustify.TOP&&(a=Math.min(f.getYForTopText(this.text_line),this.note.getYs()[0]-10),d&&(a=Math.min(a,b.topY-5-c*this.text_line)));return this.y=a},setY:function(a){this.y=a},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");
if(!this.note)throw new Vex.RERR("NoNoteForSyllable","Can't draw text annotation without an attached note.");var a=this.note.getModifierStartXY(ia.Position.ABOVE,this.index);this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.weight);var b=this.context.measureText(this.text).width,c=this.context.measureText("m").width,d;this.x=a=this.justification==z.Justify.LEFT?a.x:this.justification==z.Justify.RIGHT?a.x-b:this.justification==z.Justify.CENTER?a.x-b/2:this.note.getStemX()-
b/2;d=this.y;this.text_height=c;this.text_width=b;ra("Rendering annotation: ",this.text,a,d);this.context.fillText(this.text,a,d);this.context.restore()}});var ja=function(a){var b,c;this.init(0,a.y,1E3,{vertical_bar_width:20,top_text_position:1.5,fill_style:this.lineColor});this.options.bottom_text_position=6.5;this.setSystem(a.system);a.barlineInfo&&(b=a.barlineInfo.leftBarline,c=a.barlineInfo.rightBarline);b?(this.setBegBarType(this.barlines[b]),this.leftBarlineElement=a.barlineInfo.leftBarlineElement):
this.setBegBarType(this.barlines.invis);c&&this.setEndBarType(this.barlines[c])};Vex.Inherit(ja,l.Stave,{lineColor:"#999999",barlines:{single:l.Barline.type.SINGLE,dbl:l.Barline.type.DOUBLE,end:l.Barline.type.END,rptstart:l.Barline.type.REPEAT_BEGIN,rptend:l.Barline.type.REPEAT_END,rptboth:l.Barline.type.REPEAT_BOTH,invis:l.Barline.type.NONE},addVoltaFromInfo:function(a){var b=a.hasOwnProperty("start"),c=a.hasOwnProperty("end");b?this.setVoltaType(c?l.Volta.type.BEGIN_END:l.Volta.type.BEGIN,a.start,
30):this.setVoltaType(c?l.Volta.type.END:l.Volta.type.MID,"",30)},addClefFromInfo:function(a){this.addClef(a.type,a.size,-1===a.shift?"8vb":u);this.meiClefElement=a.meiElement},addEndClefFromInfo:function(a){this.addEndClef(a.type,"small",a.shift);this.meiEndClefElement=a.meiElement},addKeySpecFromInfo:function(a,b){this.addModifier(new l.KeySignature(a.key,b));this.meiKeySpecElement=a.meiElement},addTimeSpecFromInfo:function(a,b){var c,d;(c=a.sym)?c="cut"===c?"C|":"C":(c=a.count,d=a.unit,c=c&&d?
c+"/"+d:u);this.addTimeSignature(c,b);this.meiTimeSpecElement=a.meiElement},hasTimeSig:function(){return"undefined"!==typeof this.meiTimeSpecElement},setSystem:function(a){this.system=a},setSlurStartX:function(a){this.slurStartX=a},getSlurStartX:function(){return this.system.getSlurStartX()},setSlurEndX:function(a){this.slurEndX=a},getSlurEndX:function(){return this.system.getSlurEndX()}});var fa=function(a){this.allVexConnectors=[];a&&this.init(a)};fa.prototype={vexTypes:{line:l.StaveConnector.type.SINGLE_LEFT,
brace:l.StaveConnector.type.BRACE,bracket:l.StaveConnector.type.BRACKET,none:null,singleright:l.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:l.StaveConnector.type.SINGLE_RIGHT,dbl:l.StaveConnector.type.THIN_DOUBLE,end:l.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:l.StaveConnector.type.BOLD_DOUBLE_RIGHT,invis:null},vexTypesBarlineLeft:{single:l.StaveConnector.type.SINGLE_LEFT,dbl:l.StaveConnector.type.THIN_DOUBLE,end:l.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:l.StaveConnector.type.BOLD_DOUBLE_LEFT,
invis:null},init:function(a){var b,c,d,f,e,g,h,k,m,p=a.models,n=a.staves;a.barlineInfo&&(k=a.barlineInfo.leftBarline,m=a.barlineInfo.rightBarline);var q=a.system_n;e=a.labelMode;for(g in p)h=p[g],a=m?this.vexTypesBarlineRight[m]:this.vexTypes[h.symbol],b=n[h.top_stave_n],c=n[h.bottom_stave_n],"number"===typeof a&&b&&c&&(d=new l.StaveConnector(b,c),d.setType(a),this.allVexConnectors.push(d),"full"===e?f=0===q?h.label:h.labelAbbr:"abbr"===e&&(f=h.labelAbbr),f&&d.setText(f)),k&&(a=this.vexTypesBarlineLeft[k],
"number"===typeof a&&b&&c&&(d=new l.StaveConnector(b,c),d.setType(a),a===l.StaveConnector.type.BOLD_DOUBLE_LEFT&&(d.checkShift=!0),this.allVexConnectors.push(d)))},getAll:function(){return this.allVexConnectors},setContext:function(a){this.ctx=a;return this},draw:function(){var a,b,c,d;a=0;for(b=this.allVexConnectors.length;a<b;a+=1)c=this.allVexConnectors[a],c.checkShift&&(d=c.top_stave.getModifierXShift(),0<d&&c.setXShift(d)),c.setContext(this.ctx).draw()}};var ka=function(a){this.init(a)};ka.prototype=
{init:function(a){this.system=a.system;this.element=a.element;this.n=a.element.getAttribute("n");this.staves=a.staves;this.voices=a.voices;this.startConnectors=new fa(a.startConnectorCfg);this.inlineConnectors=new fa(a.inlineConnectorCfg);this.tieElements=a.tieElements;this.slurElements=a.slurElements;this.hairpinElements=a.hairpinElements;this.tempoElements=a.tempoElements;this.tempoFont=a.tempoFont;this.rehElements=a.rehElements;this.meiW=a.readMeasureWidths?this.setMeiWidth(this.element):null},
getSystem:function(){return this.system},setMeiWidth:function(a){return+a.getAttribute("width")||null},getStaves:function(){return this.staves},getVoices:function(){return this.voices},getMeiElement:function(){return this.element},getX:function(){return this.getFirstDefinedStave().x},getNAttr:function(){return this.n},getFirstDefinedStave:function(){var a,b;a=0;for(b=this.staves.length;a<b;a+=1)if(this.staves[a])return this.staves[a];throw new y("No staff found in the current measure.");},addRehearsalMarks:function(){var a,
b,c,d,f;c=0;for(d=this.rehElements.length;c<d;c++)f=this.rehElements[c],a=f.getAttribute("staff"),a=this.staves[a],b=0<a.getModifierXShift()?-40:0,a.modifiers.push(new l.StaveSection(r.getText(f),a.x+b,0))},addTempoToStaves:function(){var a,b,c,d,f,e,g;e=0;for(g=this.tempoElements.length;e<g;e++)a=this.tempoElements[e],d=r.attsToObj(a),b=this.staves[d.staff],f=b.getSpacingBetweenLines()/2,c=new l.StaveTempo({name:r.getText(a),duration:d["mm.unit"],dots:+d["mm.dots"],bpm:+d.mm},b.x,5),d.vo&&c.setShiftY(+d.vo*
f),a=0<b.getModifierXShift()?-14:14,b.hasTimeSig()&&(a-=24),d.ho&&(a+=+d.ho*f),c.setShiftX(a),c.font=this.tempoFont,b.modifiers.push(c)},calculateMinWidth:function(){var a,b,c,d=0,f=0;b=this.staves;for(a=b.length;a--;)if(c=b[a])d=Math.max(d,c.getNoteStartX()),f=Math.max(f,c.getGlyphEndX()-c.end_x);this.maxNoteStartX=d;this.maxEndModifierW=f;c=this.getFirstDefinedStave();a=c.modifiers[0].barline==l.Barline.type.REPEAT_BEGIN&&2<c.modifiers.length?20:0;this.minVoicesW=this.voices.preFormat();this.voiceFillFactor=
this.voices.getFillFactor();this.minWidth=d+f+a+this.minVoicesW},getVoiceFillFactor:function(){return this.voiceFillFactor},getW:function(){return this.w},getMinWidth:function(){return this.minWidth},setFinalWidth:function(a){this.w=null===this.meiW?this.minWidth+a*this.voiceFillFactor:this.meiW},format:function(a,b){for(var c=this.w,d=this.staves.length,f,e;d--;)if(this.staves[d]){f=this.staves[d];b&&"string"===typeof b[d]&&f.setText(b[d],l.Modifier.Position.LEFT,{shift_y:-3});if("function"==typeof f.setX)f.setX(a);
else for(f.x=a,f.glyph_start_x=a+5,f.bounds.x=a,e=0;e<f.modifiers.length;e++)f.modifiers[e].x=a;f.start_x=f.x+this.maxNoteStartX;f.setWidth(c);f.end_x-=this.maxEndModifierW}this.voices.format(this.getFirstDefinedStave())},draw:function(a){var b,c,d;c=this.staves;for(b=c.length;b--;)(d=c[b])&&d.setContext(a).draw();this.voices.draw(a,c);this.startConnectors.setContext(a).draw();this.inlineConnectors.setContext(a).draw()}};var la=function(){this.init()};la.prototype={STAVE_HEIGHT:40,init:function(){this.systems=
[]},formatSystems:function(a,b,c,d){var f,e,g=0,h,k=1,l=this.systems;e=l.length;if(c.pageWidth)for(f=0;f<e;f++)l[f].preFormat(d),l[f].setFinalMeasureWidths(),l[f].format(d);else{for(f=0;f<e;f++)h=l[f].preFormat(d),g<h&&(k=f,g=h);c=g+l[k].voiceFillFactorSum*c.defaultSpacingInMeasure;a.setPrintSpaceWidth(c);for(f=0;f<e;f++)l[f].setFinalMeasureWidths(c),l[f].format(d)}a.setLowestY(b.getCurrentLowestY()+this.STAVE_HEIGHT)},addSystem:function(a,b){this.systems[b]=a},getSystems:function(){return this.systems},
setContext:function(a){this.ctx=a;return this},drawSystems:function(){var a,b,c=this.systems,d=this.ctx;b=c.length;for(a=0;a<b;a++)c[a].draw(d)}};var ma=function(a){this.pageTopMar=a.pageTopMar;this.pageLeftMar=a.pageLeftMar;this.pageRightMar=a.pageRightMar;this.pageBottomMar=a.pageBottomMar;this.printSpace={top:a.pageTopMar-40,left:a.pageLeftMar,width:null===a.pageWidth?null:Math.floor(a.pageWidth-a.pageRightMar-a.pageLeftMar)-1}};ma.prototype={getPrintSpace:function(){return this.printSpace},setPrintSpaceWidth:function(a){this.printSpace.width=
a;this.widthCalculated=!0},hasCalculatedWidth:function(){return!!this.widthCalculated},getCalculatedWidth:function(){return this.printSpace.width+this.pageLeftMar+this.pageRightMar},setLowestY:function(a){this.lowestY=a},getLowestY:function(){return this.lowestY},getCalculatedHeight:function(){return this.lowestY+this.pageBottomMar}};J=function(a){this.systemVerses={};this.lowestYs={};this.font=a.font;this.maxHyphenDistance=a.maxHyphenDistance};J.prototype={addSyllable:function(a,b,c){var d=b.getAttribute("wordpos");
b=b.parentNode;b="verse"===b.localName&&b.hasAttribute("n")?b.getAttribute("n"):"1";this.systemVerses[c]||(this.systemVerses[c]={});this.systemVerses[c][b]||(this.systemVerses[c][b]={syllables:[],hyphenation:this.newHyphenation()});this.systemVerses[c][b].syllables.push(a);d&&this.systemVerses[c][b].hyphenation.addSyllable(a,d);return this},getLowestYs:function(){return this.lowestYs},getLowestY:function(a){return this.lowestYs[a]},newHyphenation:function(){return new ea(this.font,this.maxHyphenDistance)},
format:function(){var a,b,c,d,f,e,g;this.font.size=15;for(a in this.systemVerses){e=-20;for(b in this.systemVerses[a]){c=this.systemVerses[a][b].syllables;e+=20;d=0;for(f=c.length;d<f;d++)c[d].setTextLine(0),g=c[d].getModifierContext().modifiers.stavenotes,1<g.length&&c[d].setNote(g[0]),e=Math.max(e,c[d].preProcess());for(d=0;d<f;d++)c[d].setY(e)}this.lowestYs[a]=e}return this},drawHyphens:function(a,b,c){var d,f;for(d in this.systemVerses)for(f in this.systemVerses[d])this.systemVerses[d][f].hyphenation.setContext(a).draw(b,
c);return this}};var na=function(a,b,c){this.init(a,b,c)};na.prototype={LABEL_PADDING:20,init:function(a,b,c){this.leftMar=b.getLeftMar();a=a.getPrintSpace();this.coords={x:a.left,y:0===c?a.top:b.getCurrentLowestY()+b.cfg.systemSpacing,width:a.width};this.staveYs=b.getYs(this.coords.y);this.verses=new J(b.getVerseConfig());this.labels=b.getStaveLabels(c);this.measures=[];this.systemVoiceYBounds=[]},getStaveYs:function(){return this.staveYs},addMeasure:function(a){this.measures.push(a)},getMeasure:function(a){return this.measures[a]},
getMeasures:function(){return this.measures},getLastMeasure:function(){return this.measures[this.measures.length-1]},calculateLeftMar:function(a){var b,c=0,d,f,e;a.setFont("Times",16);for(b in this.labels)d=this.labels[b],"string"===typeof d&&(d=a.measureText(this.labels[b]).width,c<d&&(c=d));f=this.getMeasures()[0].startConnectors.getAll();for(e=f.length;e--;)d=f[e].text,"string"===typeof d&&(d=a.measureText(this.labels[b]).width,c<d&&(c=d));this.leftMar=0===c?0:c+this.LABEL_PADDING},calculateMinMeasureWidths:function(){for(var a=
this.measures,b=a.length;b--;)a[b].calculateMinWidth()},calculateMinSystemWidth:function(){var a,b,c=0,d=0;a=0;for(b=this.measures.length;a<b;a+=1)null===this.measures[a].meiW?(c+=this.measures[a].getMinWidth(),d+=this.measures[a].getVoiceFillFactor()):c+=this.measures[a].meiW;this.minSystemWidth=c;this.voiceFillFactorSum=d},setFinalMeasureWidths:function(a){var b,c;c=Math.floor(((a||this.coords.width)-this.leftMar-this.minSystemWidth)/this.voiceFillFactorSum);a=0;for(b=this.measures.length;a<b;a+=
1)this.measures[a].setFinalWidth(c)},preFormat:function(a){"number"!==typeof this.leftMar&&this.calculateLeftMar(a);this.calculateMinMeasureWidths();this.calculateMinSystemWidth();return this.minSystemWidth+this.leftMar},format:function(){var a,b,c,d,f;d=this.coords.x+this.leftMar;c=this.getMeasures();b=c.length;for(a=0;a<b;a+=1)c[a]&&(f=0===a?this.labels:null,c[a].format(d,f),d+=c[a].getW()),c[a].addRehearsalMarks(),c[a].addTempoToStaves();0<b&&(this.slurStartX=c[0].getFirstDefinedStave().getTieStartX(),
this.slurEndX=this.getLastMeasure().getFirstDefinedStave().getTieEndX());this.verses.format();return this},updateSystemVoiceYBounds:function(a){this.systemVoiceYBounds.push(a);console.log(this.systemVoiceYBounds)},getSlurStartX:function(){return this.slurStartX},getSlurEndX:function(){return this.slurEndX},draw:function(a){for(var b=this.measures.length;b--;)this.measures[b]&&this.measures[b].draw(a);this.verses.drawHyphens(a,this.slurStartX,this.slurEndX)}};var oa=function(a,b,c,d,f){this.renderWith=
{clef:c,keysig:d,timesig:f};this.keySpec={key:"C",meiElement:a};this.timeSpec={};this.spacing=this.labels=null;this.clef={};this.startClefCopy=null;this.updateDef(a,b,!0);this.updateRenderWithFromMEI()};oa.prototype={clefTypeMap:{G:"treble",G1:"french",G2:"treble",F3:"baritone-f",F4:"bass",F5:"subbass",C1:"soprano",C2:"mezzo-soprano",C3:"alto",C4:"tenor",C5:"baritone-c",perc:"percussion"},getCurrentScoreDef:function(){return this.currentScoreDef},updateRenderWithFromMEI:function(){debugger;this.keySpec.meiElement&&
this.keySpec.meiElement.hasAttribute("key.sig.show")&&(this.renderWith.keysig=this.getKeySigShow());this.clef.meiElement&&this.clef.meiElement.hasAttribute("clef.visible")&&(this.renderWith.clef=this.getClefVisible());this.timeSpec.meiElement&&this.timeSpec.meiElement.hasAttribute("meter.rend")&&(this.renderWith.timesig=this.getMeterRend())},updateDef:function(a,b,c){var d,f;this.currentScoreDef=b;var e=function(a,b,c){if(a&&a.hasAttribute(c))return a;if(b&&b.hasAttribute(c))return b};d=e(a,b,"clef.shape");
f=e(a,b,"key.pname");b=e(a,b,"meter.count");c||this.updateRenderWith(d,f,b);d&&this.updateClef(d);f&&this.updateKeySpec(f);b&&this.updateTimeSpec(b);a&&(this.updateLabels(a),this.updateSpacing(a))},updateIfNew:function(a){a!==this.currentScoreDef&&this.updateDef(null,a)},updateRenderWith:function(a,b,c){var d,f;d={clef:!1,keysig:!1,timesig:!1};f=function(a,b,c){return a.getAttribute(c)===b.getAttribute(c)};var e=function(a,b,c,d,e){return a.getAttribute(c+e)===b.getAttribute(d+e)},g=this.clef.meiElement,
h=this.keySpec.meiElement,k=this.timeSpec.meiElement;if(a){var l="clef"===g.localName?"":"clef.",p="clef"===a.localName?"":"clef.";e(g,a,l,p,"shape")&&e(g,a,l,p,"line")||(d.clef=!0)}!b||f(h,b,"key.pname")&&f(h,b,"key.accid")&&f(h,b,"key.mode")||(d.keysig=!0);!c||f(k,c,"meter.count")&&f(k,c,"meter.unit")&&f(k,c,"meter.sym")||(d.timesig=!0);this.renderWith=d},updateLabels:function(a){var b;b=a.getAttribute("label");"string"===typeof b&&(this.label=b);a=a.getAttribute("label.abbr");"string"===typeof a&&
(this.labelAbbr=a)},updateSpacing:function(a){a=a.getAttribute("spacing");null===a||isNaN(a)||(this.spacing=+a);return this.spacing},updateClef:function(a){var b,c,d;c="clef"===a.localName?"":"clef.";b=a.getAttribute(c+"shape");b||(w.warn("@clef.shape expected","No clef shape attribute found in "+r.serializeElement(a)+'. Setting default clef.shape "G".'),b="G");d=b+(a.getAttribute(c+"line")||"");b=a.getAttribute(c+"dis");c=a.getAttribute(c+"dis.place");(d=this.clefTypeMap[d])?this.clef="8"===b&&"below"===
c?{type:d,shift:-1,meiElement:a}:{type:d,meiElement:a}:(this.clef={type:"treble",meiElement:null},w.warn("Not supported","Clef definition in "+r.serializeElement(a)+" is not supported. Setting default treble clef."))},updateTimeSpec:function(a){this.timeSpec={count:+a.getAttribute("meter.count"),unit:+a.getAttribute("meter.unit"),sym:a.getAttribute("meter.sym"),meiElement:a}},updateKeySpec:function(a){this.keySpec={key:this.convertKeySpec(a),meiElement:a}},convertKeySpec:function(a){var b,c;b=a.getAttribute("key.pname").toUpperCase();
c=a.getAttribute("key.accid");if(null!==c)switch(c){case "s":b+="#";break;case "f":b+="b";break;default:w.warn("Not supported",'expected to find value "s" or "f" instead of "'+c+'" in @key.accid of '+r.serializeElement(a)+". Ignoring processing of this attribute.")}a=a.getAttribute("key.mode");null!==a&&(b+="major"===a?"":"m");return b},clefChangeInMeasure:function(a){this.startClefCopy||(this.startClefCopy={type:this.clef.type,size:this.clef.size,shift:this.clef.shift});this.updateClef(a);return this.clef},
checkInitialClef:function(){this.startClefCopy&&(this.changedClef=this.clef,this.clef=this.startClefCopy)},finalizeClefInfo:function(){this.changedClef&&(this.clef=this.changedClef,this.changedClef=null);this.startClefCopy=null},forceSectionStartInfo:function(){this.renderWith={clef:!0,keysig:!0,timesig:!0}},forceStaveStartInfo:function(){this.renderWith.clef=!0;this.renderWith.keysig=!0},showClefCheck:function(){if(this.renderWith.clef&&this.getClefVisible())return this.renderWith.clef=!1,!0},showKeysigCheck:function(){if(this.renderWith.keysig&&
this.getKeySigShow())return this.renderWith.keysig=!1,!0},showTimesigCheck:function(){if(this.renderWith.timesig&&(this.renderWith.timesig=!1,this.getMeterRend()))return!0},getMeterRend:function(){return this.timeSpec.meiElement&&"invis"!==this.timeSpec.meiElement.getAttribute("meter.rend")},getKeySigShow:function(){return this.keySpec.meiElement&&"false"!==this.keySpec.meiElement.getAttribute("key.sig.show")},getClefVisible:function(){return this.clef.meiElement&&"false"!==this.clef.meiElement.getAttribute("clef.visible")},
getClef:function(){return this.clef},getKeySpec:function(){return this.keySpec},getTimeSpec:function(){return this.timeSpec}};var pa=function(){};pa.prototype={STAVE_HEIGHT:40,init:function(a){this.cfg=a;this.currentStaveInfos=[];this.systemLeftMar=null;this.currentLowestY=0;this.startConnectorInfos={};this.inlineConnectorInfos={}},setLeftMar:function(a){this.systemLeftMar=a},getLeftMar:function(){return this.systemLeftMar},setConnectorModels:function(a,b,c,d){var f,e,g=function(a,b,c){a[b.top_stave_n+
":"+b.bottom_stave_n+(c||"")]=b};f=b.first_n;e=b.last_n;b=a.getAttribute("symbol");w.debug("Converter.setConnectorModels() {2}","symbol: "+b," range.first_n: "+f," range.last_n: "+e);g(this.startConnectorInfos,{top_stave_n:f,bottom_stave_n:e,symbol:b||"line",label:a.getAttribute("label"),labelAbbr:a.getAttribute("label.abbr"),ancestorSymbols:d});!c&&this.cfg.autoStaveConnectorLine&&g(this.startConnectorInfos,{top_stave_n:f,bottom_stave_n:e,symbol:"none"===b?"none":"line"},"autoline");"true"===a.getAttribute("barthru")&&
g(this.inlineConnectorInfos,{top_stave_n:f,bottom_stave_n:e,symbol:"singleright"})},getStaveInfo:function(a){return this.currentStaveInfos[a]},getAllStaveInfos:function(){return this.currentStaveInfos},getStaveLabels:function(a){var b,c,d;b={};if(!this.cfg.labelMode)return b;d="full"===this.cfg.labelMode&&0===a?"label":"labelAbbr";c=this.getAllStaveInfos();for(a=c.length;a--;)c[a]&&(b[a]=c[a][d]);return b},getVerseConfig:function(){return{font:this.cfg.lyricsFont,maxHyphenDistance:this.cfg.maxHyphenDistance}},
getClef:function(a){var b;b=this.currentStaveInfos[a];if(!b)throw new y('No staff definition for staff n="'+a+'"');return b.getClef()},getCurrentLowestY:function(){return this.currentLowestY},setCurrentLowestY:function(a){this.currentLowestY=a},getYs:function(a){var b,c,d,f=!0,e,g=[];b=0;c=1;for(d=this.currentStaveInfos.length;c<d;c+=1)this.currentStaveInfos[c]&&(e=this.currentStaveInfos[c].spacing,b+=f?0:null!==e?this.STAVE_HEIGHT+this.currentStaveInfos[c].spacing:this.STAVE_HEIGHT+this.cfg.staveSpacing,
g[c]=a+b,f=!1);a=a+b+this.STAVE_HEIGHT;a>this.currentLowestY&&(this.currentLowestY=a);return g},forceSectionStartInfos:function(){for(var a=this.currentStaveInfos.length;a--;)this.currentStaveInfos[a]&&this.currentStaveInfos[a].forceSectionStartInfo()},forceStaveStartInfos:function(){for(var a=this.currentStaveInfos.length;a--;)this.currentStaveInfos[a]&&this.currentStaveInfos[a].forceStaveStartInfo()},processScoreDef:function(a){var b,c,d;this.scoreDefElement=a;b=parseFloat(this.scoreDefElement.getAttribute("system.leftmar"));
isNaN(b)||this.setLeftMar(b);d=this.scoreDefElement.childNodes;b=0;for(c=d.length;b<c;b+=1)1===d[b].nodeType&&this.processScoreDef_child(d[b]);this.updateStaffDefs(a)},updateStaffDefs:function(a){for(var b=this.currentStaveInfos.length;b--;)this.currentStaveInfos[b]&&this.currentStaveInfos[b].getCurrentScoreDef()!==a&&this.currentStaveInfos[b].updateDef(null,a)},processScoreDef_child:function(a){switch(a.localName){case "staffGrp":this.processStaffGrp(a);break;case "pgHead":this.processPgHead(a);
break;case "pgFoot":this.processPgFoot(a);break;default:w.info("Not supported","Element <"+a.localName+"> is not supported in <scoreDef>. Ignoring element.")}},processPgHead:function(a){w.info("Not supported","Element <"+a.localName+"> is not supported in <scoreDef>. Ignoring element.")},processPgFoot:function(a){w.info("Not supported","Element <"+a.localName+"> is not supported in <scoreDef>. Ignoring element.")},processStaffGrp:function(a,b,c){var d={},f=!0,e,g,h,k;e=a.childNodes;g=0;for(h=e.length;g<
h;g++)1===e[g].nodeType&&(k=this.processStaffGrp_child(a,e[g],c))&&(w.debug("Converter.processStaffGrp() {1}.{a}","childRange.first_n: "+k.first_n," childRange.last_n: "+k.last_n),f&&(d.first_n=k.first_n),d.last_n=k.last_n,f=!1);this.setConnectorModels(a,d,b,c);return d},processStaffGrp_child:function(a,b,c){switch(b.localName){case "staffDef":return b=this.processStaffDef(b,this.scoreDefElement),{first_n:b,last_n:b};case "staffGrp":return a=c?c.concat(a.getAttribute("symbol")):[a.getAttribute("symbol")],
this.processStaffGrp(b,!0,a);default:w.info("Not supported","Element <"+b.localName+"> is not supported in <staffGrp>. Ignoring element.")}},processStaffDef:function(a,b){var c,d;c=parseInt(a.getAttribute("n"),10);if(isNaN(c))throw new y(r.serializeElement(a)+" must have an @n attribute of type integer.");(d=this.currentStaveInfos[c])?d.updateDef(a,b):this.currentStaveInfos[c]=new oa(a,b,!0,!0,!0);return c}};var wa=function(a,b){this.voice=a;this.stave_n=b},qa=function(){this.all_voices=[];this.formatter=
new l.Formatter};qa.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(a,b){this.addStaffVoice(new wa(a,b))},reset:function(){this.all_voices=[]},preFormat:function(){var a,b,c,d;a=this.all_voices;this.vexVoices=[];this.vexVoicesStaffWise={};for(c=a.length;c--;)d=a[c].voice,this.vexVoices.push(d),b=a[c].stave_n,this.vexVoicesStaffWise[b]?this.vexVoicesStaffWise[b].push(d):this.vexVoicesStaffWise[b]=[d];this.formatter.preCalculateMinTotalWidth(this.vexVoices);return this.formatter.getMinTotalWidth()},
getFillFactor:function(){var a=this.vexVoices[0],b;b=a.getTicksUsed().numerator;return 0===b?1:b/a.getTotalTicks().numerator},format:function(a){var b,c,d;c=this.formatter;for(b in this.vexVoicesStaffWise)if(d=1<this.vexVoicesStaffWise[b].length,c.joinVoices(this.vexVoicesStaffWise[b]),d){d=this.vexVoicesStaffWise[b];for(var f=0;f<d.length;f++)this.alignRestsToNotes(d[f].tickables,!0,!0)}b=a.getNoteEndX()-a.getNoteStartX()-10;c.createTickContexts(this.vexVoices);c.preFormat(b,a.getContext(),this.vexVoices,
null)},alignRestsToNotes:function(a,b,c){for(var d=function(a,b,c,d){for(c++;c<a.length;){if(!a[c].isRest()&&!a[c].shouldIgnoreTicks()){a[c].getLineForRest();break}c++}},f=0;f<a.length;++f)if(a[f]instanceof Vex.Flow.StaveNote&&a[f].isRest()&&!a[f].manualPosition){var e=a[f];if(!e.tuplet||c){var g=e.getGlyph().position.toUpperCase();if("R/4"==g||"B/4"==g)if(b||null!=e.beam)if(g=e.getKeyProps()[0],0===f)g.line=d(a,g.line,f,!1),e.setKeyLine(0,g.line);else if(0<f&&f<a.length){var h;a[f-1].isRest()?(h=
a[f-1].getKeyProps()[0].line,g.line=h):(h=a[f-1].getLineForRest(),g.line=d(a,h,f,!0));e.setKeyLine(0,g.line)}}}},getYBounds:function(){var a=this.vexVoicesStaffWise,b={},c;for(c in a){b[c]=[];for(var d=0,f=a[c].length;d<f;d++)b[c].push(a[c][d].getBoundingBox())}return b},draw:function(a){var b,c,d=this.all_voices;for(b=0;b<d.length;++b)c=d[b],this.drawVoice.call(c.voice,a)},drawVoice:function(a){for(var b=null,c=0;c<this.tickables.length;++c){var d=this.tickables[c];if(!d.getStave())throw new Vex.RuntimeError("MissingStave",
"The voice cannot draw tickables without staves.");d.setStave(d.getStave());0===c&&(b=d.getBoundingBox());if(0<c&&b){var f=d.getBoundingBox();f&&b.mergeWith(f)}d.setContext(a);d.draw()}this.boundingBox=b}};var B=function(a){a&&this.initConfig(a);return this};B.prototype={defaults:{pageWidth:null,pageTopMar:60,pageBottomMar:80,pageLeftMar:20,pageRightMar:20,defaultSpacingInMeasure:180,systemSpacing:90,staveSpacing:60,autoStaveConnectorLine:!0,labelMode:null,readMeasureWidths:!0,processSb:"sb",processPb:"sb",
maxHyphenDistance:75,lyricsFont:{family:"Times",size:15,spacing:1.3},annotFont:{family:"Times",size:15},dynamFont:{family:"Times",size:17.5,weight:"bold italic"},tempoFont:{family:"Times",size:17,weight:"bold"}},initConfig:function(a){this.cfg=r.extend({},this.defaults,a);this.systemInfo=new pa;this.pageInfo=new ma(this.cfg);switch(this.cfg.processSb){case "pb":this.onSb=this.setPendingPageBreak;break;case "sb":this.onSb=this.setPendingSystemBreak;break;default:this.onSb=this.emptyFn}switch(this.cfg.processPb){case "pb":this.onPb=
this.setPendingPageBreak;break;case "sb":this.onPb=this.setPendingSystemBreak;break;default:this.onPb=this.emptyFn}return this},emptyFn:function(){},reset:function(){this.page=new la;this.systemInfo.init(this.cfg);this.unresolvedTStamp2=[];this.allVexMeasureStaves=[];this.beams=new ca;this.tuplets=new da;this.dynamics=new Z(this.systemInfo,this.cfg.dynamFont);this.arpeggios=new X(this.systemInfo);this.directives=new Y(this.systemInfo,this.cfg.annotFont);this.fermatas=new aa(this.systemInfo);this.ornaments=
new ba(this.systemInfo);this.ties=new V(this.systemInfo,this.unresolvedTStamp2);this.slurs=new W(this.systemInfo,this.unresolvedTStamp2);this.hairpins=new U(this.systemInfo,this.unresolvedTStamp2);this.notes_by_id={};this.currentSystem_n=-1;this.pendingSystemBreak=!1;this.pendingSectionBreak=!0;this.voltaInfo=null;return this},process:function(a){"score"===a.localName?this.processScoreChildren(a):this.processScoreChildren(a.querySelector("score"));this.arpeggios.createVexFromInfos(this.notes_by_id);
this.dynamics.createVexFromInfos(this.notes_by_id);this.ornaments.createVexFromInfos(this.notes_by_id);this.directives.createVexFromInfos(this.notes_by_id);this.fermatas.createVexFromInfos(this.notes_by_id);this.ties.createVexFromInfos(this.notes_by_id);this.slurs.createVexFromInfos(this.notes_by_id);this.hairpins.createVexFromInfos(this.notes_by_id);this.tuplets.resolveSpanElements(this.notes_by_id);this.beams.resolveSpanElements(this.notes_by_id);return this},format:function(a){this.page.formatSystems(this.pageInfo,
this.systemInfo,this.cfg,a);this.beams.postFormat()},draw:function(a){this.page.setContext(a).drawSystems();this.beams.setContext(a).draw();this.tuplets.setContext(a).draw();this.ties.setContext(a).draw();this.slurs.setContext(a).draw();this.hairpins.setContext(a).draw();return this},getStaveArea:function(){var a;a=this.systemInfo.getCurrentLowestY();var b=this.getAllVexMeasureStaves(),c,d,f,e,g;c=b.length;for(e=0;c--;)if(b[c]){f=0;for(d=b[c].length;d--;)(g=b[c][d])&&(f=Math.max(f,g.getNoteStartX()));
for(d=b[c].length;d--;)(g=b[c][d])&&(e=Math.max(e,f+g.getWidth()))}return{width:e,height:a}},getAllVexMeasureStaves:function(){return this.allVexMeasureStaves},getSystems:function(){return this.page.getSystems()},getNotes:function(){return this.notes_by_id},createNewSystem:function(){var a;w.debug("Converter.createNewSystem()","{enter}");this.pendingSystemBreak=!1;this.currentSystem_n+=1;a=new na(this.pageInfo,this.systemInfo,this.currentSystem_n);this.pendingSectionBreak?(this.pendingSectionBreak=
!1,this.systemInfo.forceSectionStartInfos()):this.systemInfo.forceStaveStartInfos();this.page.addSystem(a,this.currentSystem_n);return a},processScoreChildren:function(a){var b,c,d;d={voltaInfo:null};if(a)for(c=a.childNodes,a=0,b=c.length;a<b;a++)1===c[a].nodeType&&this.processScoreChild(c[a],d);else throw new y("No score element found in the document.");},processScoreChild:function(a,b){switch(a.localName){case "scoreDef":this.systemInfo.processScoreDef(a);break;case "staffDef":this.systemInfo.processStaffDef(a,
null);break;case "pb":this.onPb(a);break;case "ending":this.processEnding(a,b);break;case "section":this.processSection(a,b);break;default:w.info("Not supported","Element "+r.serializeElement(a)+" is not supported in <score>. Ignoring element.")}},processSection:function(a,b){var c,d,f=a.childNodes;c=0;for(d=f.length;c<d;c+=1)1===f[c].nodeType&&this.processSectionChild(f[c],b)},processEnding:function(a,b){var c,d,f;f=null===b.voltaInfo;var e=function(a){for(a=a.nextSibling;a&&1!==a.nodeType;)a=a.nextSibling;
return a};d=a.firstChild;for(1!==d.nodeType&&(d=e(d));d;)c=e(d),"measure"===d.localName?(null===b.voltaInfo?b.voltaInfo={start:a.getAttribute("n")}:delete b.voltaInfo.start,!c&&f&&(b.voltaInfo.end=!0)):"ending"!==d.localName&&"section"!==d.localName||w.info("Not supported",r.serializeElement(d)+" is not supported as a child of "+r.serializeElement(a)+". Trying to process it anyway."),this.processSectionChild(d,b),d=c;f&&(b.voltaInfo=null)},processSectionChild:function(a,b){switch(a.localName){case "measure":this.processMeasure(a,
b);break;case "scoreDef":this.systemInfo.processScoreDef(a);break;case "staffDef":this.systemInfo.processStaffDef(a,null);break;case "pb":this.onPb(a);break;case "sb":this.onSb(a);break;case "ending":this.processEnding(a,b);break;case "section":this.processSection(a,b);break;default:w.info("Not supported","Element "+r.serializeElement(a)+" is not supported in <section>. Ignoring element.")}},setPendingPageBreak:function(){w.info("setPendingPageBreak() not implemented.")},setPendingSystemBreak:function(){this.pendingSystemBreak=
!0},processMeasure:function(a,b){var c,d,f;this.pendingSectionBreak||this.pendingSystemBreak?(d=this.createNewSystem(),c=!0):(d=this.page.getSystems(),c=d.length-1,d=d[c],c=!1);w.debug("Converter.processMeasure()","{enter}");var e={leftBarline:a.getAttribute("left"),rightBarline:a.getAttribute("right")};b.leftBarlineElement&&!e.leftBarline&&(e.leftBarline=b.leftBarlineElement.getAttribute("right"),e.leftBarlineElement=b.leftBarlineElement,b.leftBarlineElement=null);"rptstart"===e.rightBarline&&(e.rightBarline=
null,b.leftBarlineElement=a);var g=[],h=[],k=[],l=[],p=[],n=[],q=[],r=[],t=[],v=[],y=[],u,z;f=a.childNodes;u=0;for(z=f.length;u<z;u++)switch(f[u].localName){case null:break;case "staff":g.push(f[u]);break;case "dir":k.push(f[u]);break;case "harm":k.push(f[u]);break;case "tie":p.push(f[u]);break;case "slur":l.push(f[u]);break;case "hairpin":n.push(f[u]);break;case "tempo":q.push(f[u]);break;case "dynam":r.push(f[u]);break;case "arpeg":h.push(f[u]);break;case "fermata":t.push(f[u]);break;case "mordent":case "turn":case "trill":y.push(f[u]);
break;case "reh":v.push(f[u]);break;case "beamSpan":this.beams.addSpanElements(f[u]);break;case "tupletSpan":this.tuplets.addSpanElements(f[u]);break;default:w.info("Not supported","<"+f[u].localName+"> is not supported as child of <measure>.")}f=this.initializeStavesInMeasure(d,g,e,c,b);var A=this.allVexMeasureStaves.push(f)-1,B=new qa,C=new ga(this.notes_by_id,this.currentSystem_n);u=0;for(z=g.length;u<z;u++)this.processStaveEvents(f,g[u],A,B,C);0!==C.clefCheckQueue.length&&this.processClefCheckQueue(C);
this.dynamics.createInfos(r,a);this.arpeggios.createInfos(h,a);this.directives.createInfos(k,a);this.fermatas.createInfos(t,a);this.ornaments.createInfos(y,a);this.ties.createInfos(p,a,A,this.systemInfo);this.slurs.createInfos(l,a,A,this.systemInfo);this.hairpins.createInfos(n,a,A,this.systemInfo);c=new ka({system:d,element:a,staves:f,voices:B,startConnectorCfg:c?{labelMode:this.cfg.labelMode,models:this.systemInfo.startConnectorInfos,staves:f,system_n:this.currentSystem_n}:null,inlineConnectorCfg:{models:this.systemInfo.inlineConnectorInfos,
staves:f,barlineInfo:e},tempoElements:q,rehElements:v,tempoFont:this.cfg.tempoFont,readMeasureWidths:this.cfg.readMeasureWidths});d.addMeasure(c)},processClefCheckQueue:function(a){var b,c,d,f=a.clefCheckQueue;b=0;for(c=f.length;b<c;b++)d=f[b],d.clef!==d.stave.clef&&(d.clef=d.stave.clef,d.keyProps=[],d.calculateKeyProps(),d.buildNoteHeads(),d.buildStem());a.emptyClefCheckQueue()},initializeStavesInMeasure:function(a,b,c,d,f){var e,g,h,k,l=!0,p={},n=0,q={},t=0,u,v;k=[];d||(u=a.getLastMeasure().getStaves());
d=0;for(e=b.length;d<e;d++){h=parseInt(b[d].getAttribute("n"),10);if(isNaN(h))throw new y(r.serializeElement(b[d])+" must have an @n attribute of type integer.");g=new ja({system:a,y:a.getStaveYs()[h],barlineInfo:c});k[h]=g;l&&f.voltaInfo&&(g.addVoltaFromInfo(f.voltaInfo),l=!1);if(u&&u[h])v=this.systemInfo.getStaveInfo(h),n=v.getClef(),v.showClefCheck()&&u[h].addEndClefFromInfo(n),g.clef=n.type,n=p[h]=0;else{v=this.systemInfo.getStaveInfo(h);if(!v)throw new y(r.serializeElement(b[d])+' refers to stave "'+
h+'", but no corresponding stave definition could be found in the document.');v.showClefCheck()&&g.addClefFromInfo(v.getClef());p[h]=g.getModifierXShift();n=Math.max(n,p[h])}}e=k.length;for(d=0;d<e;d++)if(g=k[d])a=p[d]!==n?n-p[d]+10:null,v=this.systemInfo.getStaveInfo(d),v.showKeysigCheck()&&g.addKeySpecFromInfo(v.getKeySpec(),a),q[d]=g.getModifierXShift(),t=Math.max(t,q[d]);for(d=0;d<e;d++)if(g=k[d])a=q[d]!==t?t-q[d]+15:null,v=this.systemInfo.getStaveInfo(d),v.showTimesigCheck()&&g.addTimeSpecFromInfo(v.getTimeSpec(),
a);return k},processStaveEvents:function(a,b,c,d,f){var e,g,h,k,m,p;e=parseInt(b.getAttribute("n"),10)||1;a=a[e];f.startNewStave(a,e);p=this.systemInfo.getStaveInfo(e);var n=p.getTimeSpec();g=b.getElementsByTagName("layer");h=0;for(k=g.length;h<k;h++)f.setLayerDir(1<k?0===h?l.StaveNote.STEM_UP:h===k-1?l.StaveNote.STEM_DOWN:null:null),this.resolveUnresolvedTimestamps(g[h],e,c,n),p.checkInitialClef(),m=this.processNoteLikeChildren(f,g[h],p),d.addVoice(this.createVexVoice(m,n),e);b=b.getElementsByTagName("anchoredText");
h=0;for(k=b.length;h<k;h++)this.processAnchoredText(f,b[h]);f.clefChangeInfo&&(a.addEndClefFromInfo(f.clefChangeInfo),f.setClefChangeInfo(null));p.finalizeClefInfo()},createVexVoice:function(a,b){var c;if(!Array.isArray(a))throw new y("me.createVexVoice() voice_contents argument must be an array.");c=new l.Voice({num_beats:b.count,beat_value:b.unit,resolution:l.RESOLUTION});c.setStrict(!1);c.addTickables(a);return c},resolveUnresolvedTimestamps:function(a,b,c,d){var f,e;b=c+":"+(b||1)+":"+(parseInt(a.getAttribute("n"),
10)||"1");if(e=this.unresolvedTStamp2[b]){c=0;for(f=e.length;c<f;c++)e[c].setContext({layer:a,meter:d}),e[c]=null;this.unresolvedTStamp2[b]=null}},processNoteLikeChildren:function(a,b,c){var d=[],f,e,g=b.childNodes;b=0;for(f=g.length;b<f;b++)1===g[b].nodeType&&(e=this.processNoteLikeElement(a,g[b],c))&&(Array.isArray(e)?d=d.concat(e):d.push(e));return d},processNoteLikeElement:function(a,b,c){switch(b.localName){case "rest":return this.processRest(a,b,c);case "mRest":return this.processMRest(a,b,
c);case "space":return this.processSpace(a,b);case "note":return this.processNote(a,b,c);case "beam":return this.processBeam(a,b,c);case "tuplet":return this.processTuplet(a,b,c);case "chord":return this.processChord(a,b,c);case "clef":return this.processClef(a,b,c);case "bTrem":return this.processBTrem(a,b,c);default:w.info("Not supported",'Element "'+b.localName+'" is not supported. Ignoring element.')}},processAnchoredText:function(a,b){},processNote:function(a,b,c){var d,f,e,g,h,k,m,p,n,q;g=r.attsToObj(b);
f=g.tie;e=g.slur;d=MeiLib.XMLID(b);g.staff=parseInt(g.staff);try{if(p=t.getVexPitch(b),g.staff&&((q=this.allVexMeasureStaves[this.allVexMeasureStaves.length-1][g.staff])?(n=q,m=this.systemInfo.getClef(g.staff)):w.warn("Staff not found",'No stave could be found which corresponds to @staff="'+g.staff+'" specified in '+r.serializeElement(b)+'". Adding note to current stave.')),m||(m=c.getClef()),n||(n=a.getStave()),h={vexPitch:p,clef:m,element:b,atts:g,stave:n,layerDir:a.getLayerDir()},k=g.grace?new O(h):
new N(h),q&&a.addToClefCheckQueue(k),k.hasMeiStemDir&&a.isInBeam()&&a.setStemDirInBeam(!0),this.processSyllables(k,b,a.stave_n),f&&this.processAttrTie(f,d,p,g.staff||a.stave_n),e&&this.processSlurAttribute(e,d),a.addEvent(d,{meiNote:b,vexNote:k}),a.clefChangeInfo&&(t.addClefModifier(k,a.clefChangeInfo),a.setClefChangeInfo(null)),g.grace)a.graceNoteQueue.push(k);else return 0<a.graceNoteQueue.length&&(k.addModifier(0,(new l.GraceNoteGroup(a.graceNoteQueue,!1)).beamNotes()),a.graceNoteQueue=[]),k}catch(u){throw new y("An error occurred processing "+
r.serializeElement(b)+': "'+u.toString());}},processChord:function(a,b,c){var d,f,e,g,h,k,m,p,n,q,u;d=b.getElementsByTagName("note");h=r.attsToObj(b);p=h.slur;f=MeiLib.XMLID(b);h.staff=parseInt(h.staff);try{h.staff&&((u=this.allVexMeasureStaves[this.allVexMeasureStaves.length-1][h.staff])?(q=u,n=this.systemInfo.getClef(h.staff)):w.warn("Staff not found",'No stave could be found which corresponds to @staff="'+h.staff+'" specified in '+r.serializeElement(b)+'". Adding note to current stave.'));n||(n=
c.getClef());q||(q=a.getStave());g={noteElements:d,clef:n,stave:q,element:b,atts:h,layerDir:a.getLayerDir()};e=h.grace?new Q(g):new P(g);u&&a.addToClefCheckQueue(e);e.hasMeiStemDir&&a.isInBeam()&&a.setStemDirInBeam(!0);c=[];k=0;for(m=d.length;k<m;k++)this.processNoteInChord(a,k,d[k],b,e),c.push(k);h.tie&&this.processAttrTie(h.tie,f,null,h.staff||a.stave_n);p&&this.processSlurAttribute(p,f);a.addEvent(f,{meiNote:b,vexNote:e,index:c});a.clefChangeInfo&&(t.addClefModifier(e,a.clefChangeInfo),a.setClefChangeInfo(null));
if(h.grace)a.graceNoteQueue.push(e);else return 0<a.graceNoteQueue.length&&(e.addModifier(0,(new l.GraceNoteGroup(a.graceNoteQueue,!1)).beamNotes()),a.graceNoteQueue=[]),e}catch(x){a=r.serializeElement(b);k=0;for(m=d.length;k<m;k++)a+="\n    "+r.serializeElement(d[k]);throw new y("A problem occurred processing \n"+a+"\n</chord>\n: "+x.toString());}},processNoteInChord:function(a,b,c,d,f){var e,g;e=r.attsToObj(c);var h=t.getVexPitch(c);g=MeiLib.XMLID(c);e.tie&&this.processAttrTie(e.tie,g,h,parseInt(e.staff)||
a.stave_n);e.slur&&this.processSlurAttribute(e.slur,g);a.addEvent(g,{meiNote:d,vexNote:f,index:[b]});g=c.childNodes;a=0;for(d=g.length;a<d;a++)switch(g[a].localName){case "accid":e.accid=g[a].getAttribute("accid");break;case "artic":t.addArticulation(f,g[a])}e.accid&&t.processAttrAccid(e.accid,f,b);e.fermata&&t.addFermata(f,c,e.fermata,b)},processRest:function(a,b,c){var d,f;try{return d=new R({element:b,stave:a.getStave(),clef:b.hasAttribute("ploc")&&b.hasAttribute("oloc")?c.getClef():null}),f=MeiLib.XMLID(b),
a.clefChangeInfo&&(t.addClefModifier(d,a.clefChangeInfo),a.setClefChangeInfo(null)),0<a.graceNoteQueue.length&&(d.addModifier(0,(new l.GraceNoteGroup(a.graceNoteQueue,!1)).beamNotes()),a.graceNoteQueue=[]),a.addEvent(f,{meiNote:b,vexNote:d}),d}catch(e){throw new y("An error occurred processing "+r.serializeElement(b)+': "'+e.toString());}},processMRest:function(a,b,c){var d,f;try{var e={meter:c.getTimeSpec(),element:b,stave:a.getStave(),clef:b.hasAttribute("ploc")&&b.hasAttribute("oloc")?c.getClef():
null};d=new S(e);f=MeiLib.XMLID(b);0<a.graceNoteQueue.length&&(d.addModifier(0,(new l.GraceNoteGroup(a.graceNoteQueue,!1)).beamNotes()),a.graceNoteQueue=[]);a.addEvent(f,{meiNote:b,vexNote:d});return d}catch(g){throw new y("An error occurred processing "+r.serializeElement(b)+': "'+g.toString());}},processSpace:function(a,b){var c=null;if(b.hasAttribute("dur"))try{c=new I({element:b,stave:a.getStave()}),a.isInBeam()&&a.setSpaceInBeam(!0),0<a.graceNoteQueue.length&&(c.addModifier(0,(new l.GraceNoteGroup(a.graceNoteQueue,
!1)).beamNotes()),a.graceNoteQueue=[])}catch(d){throw new y("An error occurred processing "+r.serializeElement(b)+': "'+d.toString());}else w.info("@dur expected","No duration attribute in "+r.serializeElement(b)+'". Ignoring element.');return c},processClef:function(a,b,c){a.setClefChangeInfo(c.clefChangeInMeasure(b))},processBTrem:function(a,b,c){w.info("Not implemented","Element <bTrem> not implemented. Processing child nodes.");return this.processNoteLikeChildren(a,b,c)},processBeam:function(a,
b,c){var d,f,e;a.enterBeam();c=this.processNoteLikeChildren(a,b,c);if(!0===a.getSpaceInBeam())if(e=a.shiftBeamInfoToResolve(),e!==u){var g=[];f=c.length;f!==e.vexNotes.length&&w.warn("Beam content mismatch",r.serializeElement(b)+" and "+r.serializeElement(e.element)+" could not be combined, because their content does not match.");for(d=0;d<f;d++)c[d]instanceof I?g.push(e.vexNotes[d]):g.push(c[d]);d=g.filter(function(a){return a&&!0===a.beamable})}else a.addBeamInfoToResolve(b,c);else d=c.filter(function(a){return!0===
a.beamable});if(d&&1<d.length)try{this.beams.addVexObject(new l.Beam(d,!a.getLayerDir()&&!1===a.getStemDirInBeam()))}catch(h){w.error("VexFlow Error","An error occurred processing "+r.serializeElement(b)+': "'+h.toString()+'". Ignoring beam.')}a.exitBeam();return c},processTuplet:function(a,b,c){a=this.processNoteLikeChildren(a,b,c);if(0===a.length)w.warn("Missing content","Not content found in "+r.serializeElement(b)+'". Ignoring tuplet.');else return c=new l.Tuplet(a,{num_notes:parseInt(b.getAttribute("num"),
10)||3,beats_occupied:parseInt(b.getAttribute("numbase"),10)||2}),"ratio"===b.getAttribute("num.format")&&c.setRatioed(!0),c.setBracketed("true"===b.getAttribute("bracket.visible")),(b=b.getAttribute("bracket.place"))&&c.setTupletLocation("above"===b?1:-1),this.tuplets.addVexObject(c),a},processAttrTie:function(a,b,c,d){var f,e;f=0;for(e=a.length;f<e;++f)"t"!==a[f]&&"m"!==a[f]||this.ties.terminateTie(b,{vexPitch:c,stave_n:d}),"i"!==a[f]&&"m"!==a[f]||this.ties.startTie(b,{vexPitch:c,stave_n:d})},processSlurAttribute:function(a,
b){var c,d,f,e;if(a)for(c=this.parseSlurAttribute(a),f=0,e=c.length;f<e;f++)d=c[f],"t"===d.letter&&this.slurs.terminateSlur(b,{nesting_level:d.nesting_level}),"i"===d.letter&&this.slurs.startSlur(b,{nesting_level:d.nesting_level})},parseSlurAttribute:function(a){var b=[],c,d,f,e;a=a.split(" ");d=0;for(f=a.length;d<f;d+=1)if(c=a[d],1===c.length)b.push({letter:c,nesting_level:0});else if(2===c.length){e=+c[1];if(!e)throw new y("badly formed slur attribute");b.push({letter:c[0],nesting_level:e})}else throw new y("badly formed slur attribute");
return b},processSyllables:function(a,b,c){var d,f,e;f=b.getElementsByTagName("syl");b.hasAttribute("syl")&&(e=new z(b.getAttribute("syl").replace(/\s+/g," "),b,this.cfg.lyricsFont),a.addAnnotation(0,e),this.page.getSystems()[this.currentSystem_n].verses.addSyllable(e,b,c));b=0;for(d=f.length;b<d;b++)e=new z(r.getNormalizedText(f[b]),f[b],this.cfg.lyricsFont),a.addAnnotation(0,e),this.page.getSystems()[this.currentSystem_n].verses.addSyllable(e,f[b],c)}};window.MeiLib=MeiLib;window.MEI2VF={setLogging:function(a){w.setLevel.call(w,
a)},setLoggerAppender:function(a){w.setAppender.call(w,a)},Converter:{initConfig:function(a){B.prototype.initConfig(a)},reset:function(){B.prototype.reset()},process:function(a){B.prototype.process(a)},format:function(a){B.prototype.format(a)},draw:function(a){B.prototype.draw(a)},getAllVexMeasureStaffs:function(){return B.prototype.getAllVexMeasureStaves()},getStaffArea:function(){return B.prototype.getStaveArea()}},rendered_measures:null,render_notation:function(a,b,c,d,f,e,g){e=e||{};b=(new l.Renderer(b,
f||l.Renderer.Backends.CANVAS)).getContext();e.pageWidth=c;this.Converter.initConfig(e);this.Converter.reset();this.Converter.process(a[0]||a);this.Converter.format(b);this.calculatedHeight=d?null:B.prototype.pageInfo.getCalculatedHeight();B.prototype.pageInfo.hasCalculatedWidth()?this.calculatedWidth=B.prototype.pageInfo.getCalculatedWidth():this.calculatedWidth=null;+f===l.Renderer.Backends.RAPHAEL&&b.paper.setSize(this.calculatedWidth||c,this.calculatedHeight||d);g&&g(this.calculatedHeight,this.calculatedWidth);
this.Converter.draw(b);this.rendered_measures=this.Converter.getAllVexMeasureStaffs()}}})(jQuery,Vex.Flow);
